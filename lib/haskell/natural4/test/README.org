#+TITLE: L4 Dev Guide: Parser Internals

* Skills
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

After working through these examples, you should know:

** what primitives the parser deals with
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| Parser       | Token Constructor   | Example     | Description              |
|--------------+---------------------+-------------+--------------------------|
| pOtherVal    | Other Text          | some string | none of the below        |
| pNumber      | TNumber Integer     | 42          | note, no reals           |
| pRuleMarker  | RuleMarker Int Text | ÂÂ§         | 3 "\167"                 |
| pToken Every | Every               | Every       | keyword "EVERY"          |
| pToken Party | Party               | Party       | keyword "PARTY"          |
| pToken Who   | Who                 | Who         | keyword "WHO"            |
| pToken Must  | Must                | Must        | keyword "MUST"           |
| pToken Do    | Do                  | ->          | keyword "DO"             |
| pToken If    | If                  | If          | keyword "IF"             |
| pToken ...   | ...                 | ...         | see Keywords below       |
| pToken EOL   | EOL                 |             | special-case end-of-line |
| eof          |                     |             | end of file              |

See LS/BasicTypes.hs for the authoritative list of ~MyToken~ constructors.

** how CSV derives from spreadsheets and from Org-Mode tables
:PROPERTIES:
:TABLE_EXPORT_FILE: org-example.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

in org mode, we have a convention for tables:

| one |       |
| two | three |

Org-Mode can extract that to a CSV that looks like

#+begin_example
one,
two,three
#+end_example

A spreadsheet e.g. Microsoft Excel or Google Sheets can likewise "Save As" a CSV file. All the cell formatting is lost, formulas are evaluated to their values, and checkboxes are shown as TRUE and FALSE.

** how the parser preprocessor sets up indentation over single and multiple lines
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

Many languages have "semantically meaningful whitespace". YAML, Python, and Haskell, among others. Parsers for such languages employ a variety of strategies to handle indentation: see BNFC's layout rule for an example.

BNFC internally rewrites nested indents of the form

| foo | bar  | baz |
|     | quux |     |
|     | honk |     |

to more conventional ALGOL-style notation

#+begin_example
{ foo bar baz; quux; honk }
#+end_example

In our case, we introduce (conceptual) parentheses:

#+begin_example
foo ( bar ( baz ) quux honk )
#+end_example

We use parentheses as shorthand for the tokens ~GoDeeper~ and ~UnDeeper~:

#+begin_example
foo GoDeeper bar GoDeeper baz UnDeeper quux honk UnDeeper
#+end_example

** how the parser handles multi-line expressions

** how the parser handles single-line compound expressions


** how to modify the syntax of the language

** how to maintain compatibility with existing code

** how to add a new parser element

** how to add a test to match that new parser element

** how to use ghcid to save time

* Syntax and Semantics

* Exporting the test/*.csv files

To export as .csv, put your cursor over the desired table and run ~M-x org-table-export~

Or you can just run, from the ~natural4/~ directory,

#+begin_src sh
  make csv
#+end_src

* Tests
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

** Types [2021-12-02 Thu]

*** Value Expressions

more thinking, the L4Leaf thing is just a conceptual placeholder for other things

**** single non-token words

"foo"

L4Leaf (["eats"], Notype)

**** multiple words

L4Leaf (["foo", "bar", "baz"], Notype)

**** multiline lists of words
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| foo |
| bar |
| baz |

L4List [ L4Leaf (["foo"], Notype)
       , L4Leaf (["bar"], Notype)
       , L4Leaf (["baz"], Notype)
       ]

**** and/or trees
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| all of: |     |
|         | foo |
| AND     | bar |
| AND     | baz |

AA.All ( L4Leaf (["all of:"],Notype) )
       [ L4Leaf (["foo",Notype])
       , L4Leaf (["bar",Notype])
       , L4Leaf (["baz",Notype]) ]

**** dictionaries of (ValueExp, [ValueExp])

{ Key:    AA.List [AA.Leaf "give", AA.Leaf "bar", AA.Leaf "baz"]
, Values: [ { Key: "flavour", Values: ["chocolate"] }
          , { Key: "amount",  Values: ["2 scoops"]  }
          ]
}

**** optional AKA aliases

ValueExp "AKA" SingleWord

annexes a DefNameAlias rule connecting SingleWord to ValueExp

**** optional TypeSig type signatures
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

can be thought of as inline type annotations

| sender | postcode | IS | A | string |

[([ "sender", "postcode" ], string)]


**** boolstructp-1: very simple boolstructp
:PROPERTIES:
:TABLE_EXPORT_FILE: boolstructp-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   |     | thing1 |
|   | OR  | thing2 |
|   | AND | thing3 |

paramtext OR paramtext AND paramtext


**** boolstructp-2: very simple boolstructp
:PROPERTIES:
:TABLE_EXPORT_FILE: boolstructp-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   |    | thing1 |        |
|   | OR |        | thing2 |
|   |    | AND    | thing3 |

paramtext OR ( paramtext AND paramtext )

**** labeled elements in an anyall list
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |             |              |          |
| MUST  | fart   | loudly      |              |          |
|       | AND    | make amends |              |          |
|       |        |             | run          | away     |
|       |        | OR          | apologize    |          |
|       |        |             | apologyLevel | profuse  |
|       |        |             | posture      | kneeling |


**** boolstructp-3: with typically
:PROPERTIES:
:TABLE_EXPORT_FILE: boolstructp-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person         |     |                  |           |       |   |
| WHO   |                | is  | immortal         | TYPICALLY | false |   |
|       | OR             | has | health insurance |           |       |   |
| MAY   | sharpen knives |     |                  |           |       |   |

when we run `stack run -- --only grounds test/boolstructp-3.csv` we should see one ground

when we run `stack run -- --only grounds --extd test/boolstructp-3.csv` we should see two grounds

**** inline-1: inline conjunctive lists

***** inline-1-a
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Food  |             |   |
| MEANS | yummy | nightshades |   |
|       |       | potato      |   |
|       | OR    | tomato      |   |
***** inline-1-a2 -- not supposed to pass
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-a2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

labels are allowed to be a single word, but cannot be MultiTerm. So this won't work.

|       | Food  |             |      |        |
| MEANS | yummy | nightshades | with | spices |
|       |       | potato      | with | salt   |
|       | OR    | tomato      | with | pepper |

***** inline-1-b
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| any of the prescribed personal data or classes of personal data relating to the individual |       |       |                                                                                                                                                                                                                                                                                                                              |
| MEANS                                                                                      | FALSE |       | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                                                                                          |
| OR                                                                                         | FALSE |       | The income of the individual from the sale of any goods or property.                                                                                                                                                                                                                                                         |
| OR                                                                                         | FALSE |       | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                                                                                                         |
| OR                                                                                         | FALSE |       | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                                                                                               |
| OR                                                                                         | FALSE |       | Any information that identifies, or is likely to lead to the identification of, the individual as a child or young person who —                                                                                                                                                                                              |
|                                                                                            |       | FALSE | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                                                                                              |
|                                                                                            | OR    | FALSE | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                                                                                            |
|                                                                                            | OR    | FALSE | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA;                                                                           |
|                                                                                            | OR    | FALSE | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                                                                                                       |
|                                                                                            | OR    | FALSE | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                                                                                                        |
| OR                                                                                         | FALSE |       | Any information that identifies, or is likely to lead to the identification of —                                                                                                                                                                                                                                             |
|                                                                                            |       | FALSE | the individual who has been or is the subject of any investigation, examination, assessment or treatment under the VAA relating to whether the individual is a vulnerable adult experiencing or at risk of abuse, neglect or self-neglect;                                                                                   |
|                                                                                            | OR    | FALSE | the individual as a vulnerable adult who has been committed to a place of temporary care and protection or place of safety or to the care of a fit person under the VAA;                                                                                                                                                     |
|                                                                                            | OR    | FALSE | the individual as a vulnerable adult who is the subject of an order made by a court under the VAA;                                                                                                                                                                                                                           |
|                                                                                            | OR    | FALSE | a place of temporary care and protection or place of safety in which an individual or a vulnerable adult mentioned in sub-paragraph (a), (b) or (c) is committed, or the location of such a place of temporary care and protection or place of safety; or                                                                    |
|                                                                                            | OR    | FALSE | a fit person under whose care an individual or a vulnerable adult mentioned in sub-paragraph (a), (b) or (c) is placed, or the location of the premises of such a fit person.                                                                                                                                                |
| OR                                                                                         | FALSE |       | Any private key of or relating to the individual that is used or may be used —                                                                                                                                                                                                                                               |
|                                                                                            |       | FALSE | to create a secure electronic record or secure electronic signature;                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | to verify the integrity of a secure electronic record; or                                                                                                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE | to verify the authenticity or integrity of a secure electronic signature.                                                                                                                                                                                                                                                    |
| OR                                                                                         | FALSE |       | The net worth of the individual.                                                                                                                                                                                                                                                                                             |
| OR                                                                                         | FALSE |       | The deposit of moneys by the individual with any organisation.                                                                                                                                                                                                                                                               |
| OR                                                                                         | FALSE |       | The withdrawal by the individual of moneys deposited with any organisation.                                                                                                                                                                                                                                                  |
| OR                                                                                         | FALSE |       | The granting by an organisation of advances, loans and other facilities by which the individual, being a customer of the organisation, has access to funds or financial guarantees.                                                                                                                                          |
| OR                                                                                         | FALSE |       | The incurring by the organisation of any liabilities other than those mentioned in paragraph 11 on behalf of the individual.                                                                                                                                                                                                 |
| OR                                                                                         | FALSE |       | The payment of any moneys, or transfer of any property, by any person to the individual, including the amount of the moneys paid or the value of the property transferred, as the case may be.                                                                                                                               |
| OR                                                                                         | FALSE |       | The creditworthiness of the individual.                                                                                                                                                                                                                                                                                      |
| OR                                                                                         | FALSE |       | The individual’s investment in any capital markets products.                                                                                                                                                                                                                                                                 |
| OR                                                                                         | FALSE |       | The existence, and amount due or outstanding, of any debt —                                                                                                                                                                                                                                                                  |
|                                                                                            |       | FALSE | owed by the individual to an organisation; or                                                                                                                                                                                                                                                                                |
|                                                                                            | OR    | FALSE | owed by an organisation to the individual.                                                                                                                                                                                                                                                                                   |
| OR                                                                                         | FALSE |       | Any of the following:                                                                                                                                                                                                                                                                                                        |
|                                                                                            |       | FALSE | the terms and conditions of any accident and health policy or life policy (called in this item the applicable policy) of which the individual is the policy owner or under which the individual is a beneficiary;                                                                                                            |
|                                                                                            | OR    | FALSE | the premium payable by the policy owner under the applicable policy;                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | the benefits payable to any beneficiary under the applicable policy;                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | any information relating to any claim on, or payment under, the applicable policy, including the condition of the health of the individual and the diagnosis, treatment, prevention or alleviation of any ailment, condition, disability, disease, disorder or injury that the individual has suffered or is suffering from; |
|                                                                                            | OR    | FALSE | any other information that the individual is the policy owner of, or a beneficiary under, an applicable policy.                                                                                                                                                                                                              |
| OR                                                                                         | FALSE |       | The assessment, diagnosis, treatment, prevention or alleviation by a health professional of any of the following affecting the individual:                                                                                                                                                                                   |
|                                                                                            |       | FALSE | any sexually-transmitted disease such as Chlamydial Genital Infection, Gonorrhoea and Syphilis;                                                                                                                                                                                                                              |
|                                                                                            | OR    | FALSE | Human Immunodeficiency Virus Infection;                                                                                                                                                                                                                                                                                      |
|                                                                                            | OR    | FALSE | schizophrenia or delusional disorder;                                                                                                                                                                                                                                                                                        |
|                                                                                            | OR    | FALSE | substance abuse and addiction, including drug addiction and alcoholism.                                                                                                                                                                                                                                                      |
| OR                                                                                         | FALSE |       | The provision of treatment to the individual for or in respect of —                                                                                                                                                                                                                                                          |
|                                                                                            |       | FALSE | the donation or receipt of a human egg or human sperm; or                                                                                                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE | any contraceptive operation or procedure or abortion.                                                                                                                                                                                                                                                                        |
| OR                                                                                         | FALSE |       | Any of the following:                                                                                                                                                                                                                                                                                                        |
|                                                                                            |       | FALSE | subject to section 4(4)(b) of the Act, the donation and removal of any organ from the body of the deceased individual for the purpose of its transplantation into the body of another individual;                                                                                                                            |
|                                                                                            | OR    | FALSE | the donation and removal of any specified organ from the individual, being a living organ donor, for the purpose of its transplantation into the body of another individual;                                                                                                                                                 |
|                                                                                            | OR    | FALSE | the transplantation of any organ mentioned in sub-paragraph (a) or (b) into the body of the individual.                                                                                                                                                                                                                      |
| OR                                                                                         | FALSE |       | Subject to section 4(4)(b) of the Act, the suicide or attempted suicide of the individual.                                                                                                                                                                                                                                   |
| OR                                                                                         | FALSE |       | Domestic abuse, child abuse or sexual abuse involving or alleged to involve the individual.                                                                                                                                                                                                                                  |
| OR                                                                                         | FALSE |       | Any of the following:                                                                                                                                                                                                                                                                                                        |
|                                                                                            |       | FALSE | information that the individual is or had been adopted pursuant to an adoption order made under the Adoption of Children Act (Cap. 4), or is or had been the subject of an application for an adoption order;                                                                                                                |
|                                                                                            | OR    | FALSE | the identity of the natural father or mother of the individual;                                                                                                                                                                                                                                                              |
|                                                                                            | OR    | FALSE | the identity of the adoptive father or mother of the individual;                                                                                                                                                                                                                                                             |
|                                                                                            | OR    | FALSE | the identity of any applicant for an adoption order;                                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | the identity of any person whose consent is necessary under that Act for an adoption order to be made, whether or not the court has dispensed with the consent of that person in accordance with that Act;                                                                                                                   |
|                                                                                            | OR    | FALSE | any other information that the individual is or had been an adopted child or relating to the adoption of the individual.                                                                                                                                                                                                     |
|                                                                                            |       |       |                                                                                                                                                                                                                                                                                                                              |
***** inline-1-c
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-c.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:


challenge: use a combination of parsers to read this stuff into some kind of structure

|       | Bad |                  |   |    |              |
| MEANS | any | unauthorised     |   |    | access       |
|       |     |                  |   | OR | use          |
|       |     |                  |   | OR | disclosure   |
|       |     |                  |   | OR | copying      |
|       |     |                  |   | OR | modification |
|       |     |                  |   | OR | disposal     |
|       |     |                  |   |    |              |
|       |     | of personal data |   |    |              |

#+begin_example
1 match MEANS
2 some GoDeeper
3 match some (pNumAsText <* GoDeeper)   -- "any", "unauthorised"

looking ahead,
4 some GoDeeper                         -- | | |
5 match some (pNumAsText <* GoDeeper)   -- "access" (TYPICALLY False)
6 some UnDeeper                         -- | | to the left
7 match OR | AND | UNLESS | NOT         -- and we are in the desired column

then we want to place the cursor at the column of the OR | AND | UNLESS | NOT; we can compute that as the number of goDeepers found in 4 plus 5 minus 6

we consume that number of GoDeepers
and then we match pBSR
and then we |<< to match "of personal data"

for this to work, we need to be able to return the successful lookAhead match, and show how many GoDeepers and UnDeepers were involved in 4, 5, and 6.
#+end_example

***** we want to support the "post" line at any indentation level between the IS and the OR
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-d.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |              |   |                  |              |
| MEANS | any | unauthorised |   |                  | access       |
|       |     |              |   | OR               | use          |
|       |     |              |   | OR               | disclosure   |
|       |     |              |   | OR               | copying      |
|       |     |              |   | OR               | modification |
|       |     |              |   | OR               | disposal     |
|       |     |              |   | of personal data |              |

***** inline +3 / -1
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-e.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |              |                  |    |              |
| MEANS | any | unauthorised |                  |    | access       |
|       |     |              |                  | OR | use          |
|       |     |              |                  | OR | disclosure   |
|       |     |              |                  | OR | copying      |
|       |     |              |                  | OR | modification |
|       |     |              |                  | OR | disposal     |
|       |     |              | of personal data |    |              |


***** inline +3 / -2
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-f.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |                  |   |    |              |
| MEANS | any | unauthorised     |   |    | access       |
|       |     |                  |   | OR | use          |
|       |     |                  |   | OR | disclosure   |
|       |     |                  |   | OR | copying      |
|       |     |                  |   | OR | modification |
|       |     |                  |   | OR | disposal     |
|       |     | of personal data |   |    |              |

***** inline +3 / -3
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-g.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad              |              |   |    |              |
| MEANS | any              | unauthorised |   |    | access       |
|       |                  |              |   | OR | use          |
|       |                  |              |   | OR | disclosure   |
|       |                  |              |   | OR | copying      |
|       |                  |              |   | OR | modification |
|       |                  |              |   | OR | disposal     |
|       | of personal data |              |   |    |              |

***** inline +2 / -3
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-h.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad              |              |    |              |
| MEANS | any              | unauthorised |    | access       |
|       |                  |              | OR | use          |
|       |                  |              | OR | disclosure   |
|       |                  |              | OR | copying      |
|       |                  |              | OR | modification |
|       |                  |              | OR | disposal     |
|       | of personal data |              |    |              |
***** inline +1 / -3
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-i.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad              |   |              |              |
| MEANS | any              |   | unauthorised | access       |
|       |                  |   | OR           | use          |
|       |                  |   | OR           | disclosure   |
|       |                  |   | OR           | copying      |
|       |                  |   | OR           | modification |
|       |                  |   | OR           | disposal     |
|       | of personal data |   |              |              |
***** inline +1 / -2
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-i.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |                  |              |              |
| MEANS | any |                  | unauthorised | access       |
|       |     |                  | OR           | use          |
|       |     |                  | OR           | disclosure   |
|       |     |                  | OR           | copying      |
|       |     |                  | OR           | modification |
|       |     |                  | OR           | disposal     |
|       |     | of personal data |              |              |
***** inline +1 / +1 / -0
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-j.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |   |                  |              |
| MEANS | any |   | unauthorised     | access       |
|       |     |   | OR               | use          |
|       |     |   | OR               | disclosure   |
|       |     |   | OR               | copying      |
|       |     |   | OR               | modification |
|       |     |   | OR               | disposal     |
|       |     |   | of personal data |              |
***** inline +0 / +1 / -0
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-k.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |                  |              |
| MEANS | any | unauthorised     | access       |
|       |     | OR               | use          |
|       |     | OR               | disclosure   |
|       |     | OR               | copying      |
|       |     | OR               | modification |
|       |     | OR               | disposal     |
|       |     | of personal data |              |
***** inline +0 / +1 / -1
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-l.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad              |              |              |           |      |
| MEANS | any              | unauthorised | access       |           |      |
|       |                  | OR           | use          |           |      |
|       |                  | OR           | disclosure   |           |      |
|       |                  | OR           | copying      |           |      |
|       |                  | OR           | modification |           |      |
|       |                  | OR           | disposal     | TYPICALLY | True |
|       | of personal data |              |              |           |      |
***** inline +0 / +1 / -1 / +2
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-m.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:


|       | Bad              |              |    |   |              |
| MEANS | any              | unauthorised |    |   | access       |
|       |                  |              | OR |   | use          |
|       |                  |              | OR |   | disclosure   |
|       |                  |              | OR |   | copying      |
|       |                  |              | OR |   | modification |
|       |                  |              |    |   |              |
|       |                  |              | OR |   | disposal     |
|       | of personal data |              |    |   |              |
***** inline no post
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-n.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

what if there is a blank column to the right of the OR? we need to match as many GoDeepers as are needed to hit the OR

                    pOtherval +?        pOtherVal (UnDeeper+) (AND | OR) GoDeeper+ pOtherVal

we count the number of UnDeeper+ captured, and use that to limit the greediness of the
initial ~pOtherval +?~ component.

|       | Bad |              |    |   |              |
| MEANS | any | unauthorised |    |   | access       |
|       |     |              | OR |   | use          |
|       |     |              | OR |   | disclosure   |
|       |     |              | OR |   | copying      |
|       |     |              | OR |   | modification |
|       |     |              |    |   |              |
|       |     |              | OR |   | disposal     |

***** o: inline no pre
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-o.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bad |   |    |            |          |              |
| MEANS |     |   |    | access     |          |              |
|       |     |   | OR |            | use      |              |
|       |     |   | OR | disclosure |          |              |
|       |     |   | OR |            | copying  |              |
|       |     |   | OR |            |          | modification |
|       |     |   | OR |            | disposal |              |

***** p: this parses: inline fragment of pdpadbno4
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-p.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | wonk |   |    |      |   |
| MEANS | a    |   |    | honk |   |
|       |      |   | OR | ponk |   |

wonk MEANS (a /    (    ( honk )
                     OR ( ponk ) ) )

AA.Any (Label Pre "a") / [Item honk, Item ponk]

***** q: this parses:
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-q.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | poowonk |   |   |      |
| MEANS | poopoo  |   |   |      |
| OR    | just a  |   |   | honk |

( poowonk ) MEANS ( poopoo ) OR ( just a ( ( honk ) ) )

***** r: this parses now:
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-r.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | multiwonk |   |    |      |   |
| MEANS | poopoo    |   |    |      |   |
| OR    | the       |   |    | honk |   |
|       |           |   | OR | ponk |   |

( multiwonk ) MEANS ( poopoo ) OR (the ( ( ( honk ) OR ( ponk ) ) ) )

***** when everything works we should be able to parse this:
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-1-s.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| a data breach occurred |                                                                                                 |                                         |   |    |       |              |
| MEANS                  | any                                                                                             | unauthorised                            |   |    | FALSE | access       |
|                        |                                                                                                 |                                         |   | OR | FALSE | use          |
|                        |                                                                                                 |                                         |   | OR | TRUE  | disclosure   |
|                        |                                                                                                 |                                         |   | OR | FALSE | copying      |
|                        |                                                                                                 |                                         |   | OR | FALSE | modification |
|                        |                                                                                                 |                                         |   | OR | TRUE  | disposal     |
|                        |                                                                                                 | of personal data                        |   |    |       |              |
| OR                     | loss of storage medium on which personal data is stored in circumstances where the unauthorised |                                         |   |    | FALSE | access       |
|                        |                                                                                                 |                                         |   | OR | FALSE | use          |
|                        |                                                                                                 |                                         |   | OR | FALSE | disclosure   |
|                        |                                                                                                 |                                         |   | OR | FALSE | copying      |
|                        |                                                                                                 |                                         |   | OR | TRUE  | modification |
|                        |                                                                                                 |                                         |   | OR | TRUE  | disposal     |
|                        |                                                                                                 | of the personal data is likely to occur |   |    |       |              |

***** PDPA Part 1 - simpler
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| personal data |    |       |
| MEANS         |    | alpha |
| OR            |    | beta  |
| OR            |    | gamma |
|               |    | c1    |
|               | OR | c2    |
|               | OR | c3    |

***** PDPA Part 1 - fancier -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

it works if you outdent the 5 to match the left margin of the inner "OR"

because a label has to be a single string this flattens to "5 gamma"

it does preserve the separation between "5.a" and "c1" etc though. so that's good.

| personal data |    |       |       |
| MEANS         |    | 1     | alpha |
| OR            |    | 2     | beta  |
| OR            | 5  | gamma |       |
|               |    | 5.a   | c1    |
|               | OR | 5.b   | c2    |
|               | OR | 5.c   | c3    |

***** withlabels indented first way -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-c.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| any of the prescribed personal data or classes of personal data relating to the individual |       |       |     |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      | FALSE |       |   1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         | FALSE |       |   2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         | FALSE |       |   3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         | FALSE |       |   4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | FALSE |       |   5 | Any information that identifies, or is likely to lead to the identification of, the individual as a child or young person who —                                                                                                                    |
|                                                                                            |       | FALSE | 5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE | 5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR    | FALSE | 5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR    | FALSE | 5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR    | FALSE | 5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR    | FALSE | 5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |




***** withlabels indented second way -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-d.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| any of the prescribed personal data or classes of personal data relating to the individual |       |       |     |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      | FALSE |       |   1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         | FALSE |       |   2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         | FALSE |       |   3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         | FALSE |       |   4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | FALSE | 5     |     | Any information that identifies, or is likely to lead to the identification of, the individual as a child or young person who —                                                                                                                    |
|                                                                                            |       | FALSE | 5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE | 5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR    | FALSE | 5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR    | FALSE | 5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR    | FALSE | 5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR    | FALSE | 5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |


***** withlabels indented third way -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-e.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

the FALSE gets in the way.

| any of the prescribed personal data or classes of personal data relating to the individual |    |       |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      |    |     1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         |    |     2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         |    |     3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         |    |     4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | 5  | FALSE | Any information that ...                                                                                                                                                                                                                           |
|                                                                                            |    |   5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR |   5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR |   5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR |   5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR |   5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR |   5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |

***** withlabels indented fourth way -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-f.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

only change, remove the FALSE

| any of the prescribed personal data or classes of personal data relating to the individual |    |     |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      |    |   1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         |    |   2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         |    |   3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         |    |   4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | 5  |     | Any information that ...                                                                                                                                                                                                                           |
|                                                                                            |    | 5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR | 5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR | 5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR | 5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR | 5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR | 5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |

***** withlabels indented fifth way -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-g.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

only change, move the "any information that" one column to the left

| any of the prescribed personal data or classes of personal data relating to the individual |    |                          |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      |    |                        1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         |    |                        2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         |    |                        3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         |    |                        4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | 5  | Any information that ... |                                                                                                                                                                                                                                                    |
|                                                                                            |    |                      5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR |                      5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR |                      5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR |                      5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR |                      5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR |                      5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |

i guess we'll just have to do that for the input spreadsheets.

***** withlabels indented sixth way -- works
:PROPERTIES:
:TABLE_EXPORT_FILE: inline-2-h.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| any of the prescribed personal data or classes of personal data relating to the individual |       |       |                    |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      | FALSE |       |                  1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         | FALSE |       |                  2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         | FALSE |       |                  3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         | FALSE |       |                  4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | FALSE | 5     | Any information... |                                                                                                                                                                                                                                                    |
|                                                                                            |       | FALSE |                5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE |                5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR    | FALSE |                5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR    | FALSE |                5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR    | FALSE |                5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR    | FALSE |                5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |

all six indentation styles now work.


*** how do we deal with blanks in between things we care about?

**** we can expect an slMultiTerm to parse this:
:PROPERTIES:
:TABLE_EXPORT_FILE: multiterm-with-blanks-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| foo | bar | baz |

**** what about:
:PROPERTIES:
:TABLE_EXPORT_FILE: multiterm-with-blanks-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| foo |   | bar |   |   | baz |

should we expect an slMultiterm to parse it? decision: yes, we should.

**** what about the same column but next line?
:PROPERTIES:
:TABLE_EXPORT_FILE: multiterm-with-blanks-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| foo |   | bar |
|     |   | baz |

does this (erroneously IMHO) return [foo bar baz]?
no, the parser fails, which is correct.

*** variable substitution

**** varsub-1-headhead: define one thing in terms of another thing, in the head
:PROPERTIES:
:TABLE_EXPORT_FILE: varsub-1-headhead.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

This gets parsed into:
- c :: HC2 { hHead = c RPis All [a  b ], hBody = Nothing }
- b :: HC2 { hHead = b RPis All [b1 b2], hBody = Nothing }

|       | c  |
| MEANS | a  |
| OR    | b  |
| ;;    |    |
|       | b  |
| MEANS | b1 |
| AND   | b2 |

c = a || (b1 && b2)

we know how to expand a head with a head

**** varsub-2-headbody: define one thing in terms of another thing, in the head and body
:PROPERTIES:
:TABLE_EXPORT_FILE: varsub-2-headbody.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

c is a horn head definition

b is a horn body definition

This gets parsed into:
- c :: HC2 { hHead = c RPis All [a  b ], hBody = Nothing     }
- b :: HC2 { hHead = b,                  hBody = All [b1 b2] }

|        | c  |
| MEANS  | a  |
| OR     | b  |
| ;;     |    |
| DECIDE | b  |
| IF     | b1 |
| AND    | b2 |

This should define c = a || (b1 && b2)

we need to be able to expand a head with a body

**** varsub-3-bodybody: define one thing in terms of another thing, in the body and body
:PROPERTIES:
:TABLE_EXPORT_FILE: varsub-3-bodybody.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

This gets parsed into:
- c :: HC2 { hHead = c, hBody = Any [a  b ] }
- b :: HC2 { hHead = b, hBody = All [b1 b2] }

| DECIDE | c  |
| IF     | a  |
| OR     | b  |
| ;;     |    |
| DECIDE | b  |
| IF     | b1 |
| AND    | b2 |

This should define c = a || (b1 && b2)

we need to be able to expand a body with a body

**** varsub-4-bodyhead: define one thing in terms of another thing, in the body and head
:PROPERTIES:
:TABLE_EXPORT_FILE: varsub-4-bodyhead.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

This gets parsed into:
- c :: HC2 { hHead = c,                  hBody = Any a b }
- b :: HC2 { hHead = b RPis All [b1 b2], hBody = Nothing }

| DECIDE | c  |
| IF     | a  |
| OR     | b  |
| ;;     |    |
|        | b  |
| MEANS  | b1 |
| AND    | b2 |

This should define c = a || (b1 && b2)

we know how to expand a body with a head

**** regexpand-1: regulatives conjoined via a rulealias
:PROPERTIES:
:TABLE_EXPORT_FILE: regexpand-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §      | Rule1       |        |
| PARTY  | Alice       |        |
| MAY    | act         |        |
| BEFORE | deadline    |        |
| HENCE  | TwoRules    |        |
| ;;     |             |        |
|        | TwoRules    |        |
| MEANS  | Rule2a      |        |
| AND    | Rule2b      |        |
| ;;     |             |        |
| §      | Rule2a      |        |
| PARTY  | Bob         |        |
| MUST   | acknowledge | action |
| ;;     |             |        |
| §      | Rule2b      |        |
| PARTY  | Carol       |        |
| MUST   | pay         | Alice  |

This should link up Bob and Carol's subcontracts 2a and 2b as pursuant to Alice's subcontract 1.

*** About the src/Parser.hs

**** At the same depth, NOT binds tighter than OR binds tigher than AND.

**** Indentation depth acts as implicit parentheses.

**** indent-2-a: no meaningful indentation
:PROPERTIES:
:TABLE_EXPORT_FILE: indent-2-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

originally
|     | a   |   |
| AND | b   |   |
| OR  | c   |   |
| OR  | NOT | d |

#+begin_example
if (and a (or b c (not d)))

 a  && ( b  ||  c  || (!  d))

(a) && ((b) || (c) || (! (d)))
#+end_example

***** explicitly
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| IF  | (A)  |      |
| AND | (B)  |      |
| OR  | (C)  |      |
| OR  | (NOT | (D)) |

ignoring the newlines,

whenever we increase indentation level we insert a (

whenever we decrease indentation level we insert a )

***** does that rule work for
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|             | (a   | (aa | (aaa |   |   | (((:: | (AType |
| ))))))) AND | (b   |     |      |   |   |       |        |
| ) OR        | (c   |     |      |   |   |       |        |
| ) OR        | (NOT |     |      |   |   |       |        |
|             |      | (d  |      |   |   |       |        |
| )) OR       | (e   |     |      |   |   |       |        |
| )           |      |     |      |   |   |       |        |

| MUST | (notify | (to   | (Bob | )) |   |
|      |         | (from | (    | )) |   |
|      |         |       |      |    | ) |

Any sufficiently complicated C or Fortran program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of Common Lisp.

**** Deriving the Grammar
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

So we know that a binary term looks like this:

|       | term1 |
| binOp | term2 |

if the "cursor" is initially located in the blank cell, our parser would need to consume:

GoDeeper, term, UnDeeper, binOp, GoDeeper, term, UnDeeper

and that would leave the "cursor" in the same column as it started, on the line after term2.

our ~myindented~ combinator helps tidy this up:

myindented term, binOp, myindented term

***** If term2 were itself a binary expression,

|        | term1   |
| binOp1 | term2-a |
| binOp2 | term2-b |

term1 binOp1 (term2-a binOp2 term2-b)

note that in practice the blank cell may not be blank; the cursor may be there after processing an "IF".

***** What if we have an intentional indent?

|     | term1 |       |
| OR  |       | term2 |
|     | AND   | term3 |
| OR  | term4 |       |

Because we normally bind OR tighter than AND we need to indent the AND expression:

(term1 OR (term2 AND term3) OR term4)

so, our "outer" parser would consume

GoDeeper, term1, UnDeeper, OR, GoDeeper

then instead of finding a pOtherVal it needs to consume the inner AND:

GoDeeper, term2, UnDeeper, AND, GoDeeper, term3, UnDeeper

and now it's as though it had just processed a single term2-a, and can proceed back to

UnDeeper, OR, GoDeeper, term4

so the "inner portion" of a nested expression is exactly a

(myindented term) binop (myindented term)

And the outer portion becomes

myindented term1, OR, myindented (myindented term2, AND, myindented term3), OR, myindented term4

**** indent-2-b: slightly harder indentation
:PROPERTIES:
:TABLE_EXPORT_FILE: indent-2-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

still means the same thing but with slightly more indentation

|     | a  |     |   |
| AND | b  |     |   |
|     | OR | c   |   |
|     | OR | NOT | d |

**** indent-2-c: Handle labels at the parents; this is not expected to parse
:PROPERTIES:
:TABLE_EXPORT_FILE: indent-2-c.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|    | top1 |                 |
| OR | top2 |                 |
| OR |      | this is a label |
|    |      | mid3            |
|    | OR   | mid4            |

OR, (godeeper, label, undeeper), boolstructr

***** becomes
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|    | (top1) |                  |
| OR | (top2) |                  |
| OR | (      | (this is a label |
|    |        | mid4)            |
|    | OR     | (mid5))          |

***** how to parse this?

#+begin_src haskell
    MyAny [ MyLeaf "top1"
          , MyLeaf "top2"
          , MyLabel "this is a label" $
              MyAny [ MyLeaf "mid3"
                    , MyLeaf "mid4"]
          ]
#+end_src

**** indent-2-c-2: more label variation, right; ; this is not expected to parse
:PROPERTIES:
:TABLE_EXPORT_FILE: indent-2-c-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|    | top1 |      |                 |
| OR | top2 |      |                 |
| OR |      |      | this is a label |
|    |      | mid3 |                 |
|    | OR   | mid4 |                 |

OR, godeeper, (godeeper, godeeper, label, undeeper, undeeper), boolstructr

**** indent-2-c-3: more label variation, left; this is the only working syntax for the moment, so we shall use this for the demo.
:PROPERTIES:
:TABLE_EXPORT_FILE: indent-2-c-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|    | top1            |      |   |
| OR | top2            |      |   |
| OR | this is a label |      |   |
|    |                 | mid3 |   |
|    | OR              | mid4 |   |

or, godeeper, label, samedepth boolstructr

**** indent-2-d: more indentation variant
:PROPERTIES:
:TABLE_EXPORT_FILE: indent-2-d.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

As discussed above in "Deriving the Grammar":

|    | term1 |       |
| OR |       | term2 |
|    | AND   | term3 |
| OR | term4 |       |
| OR | term5 |       |



***** ParamText

one or more normal words with optional typesig

****** contexts

- Rule Action
- GIVEN parameter input to a DECIDE function
- HAS relation definition
- DECLARE type declaration

****** paramtext-1: simple case
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| one word |

****** paramtext-2: simple case, typed
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| one word | IS | A | String |

****** paramtext-2-a: simple case, typed a different way
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-2-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| one word | IS A | String |

****** paramtext-2-b: simple case, typed a different way
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-2-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| one word | :: | String |

****** paramtext-3: simple case, two words
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| two | words |
****** paramtext-3-b: simple case, two words, typed
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-3-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| two | words | :: | String |
****** paramtext-4-a: multiline
:PROPERTIES:
:TABLE_EXPORT_FILE: paramtext-4-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| two  | words | :: | String | AKA | TwoWords |
| next | line  |    |        |     |          |

****** example: rule action
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| NOTIFY | the PDPC            |
| with   | a list of names     |
| using  | a prescribed format |

****** example: GIVEN parameter input to a DECIDE function
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| GIVEN | Sign1 |   | Sign2 | IS | A | Sign |   |   |   |

****** example: HAS relation definition

HAS ParamText

****** example: DECLARE

DECLARE ParamText

***** HornClause

****** fragments
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-0-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

a tiny fragment of a horn clause

| X | IS | Y |

******* decide
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-0-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

let's put a DECIDE in front of it

| DECIDE | X | IS | Y |

****** horn-0-3: multiterm support in RPConstraint
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-0-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| X1 | X2 | IS | Y |

****** horn-0-4: multiterm support in RPConstraint
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-0-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| X1 | X2 | IS | Y1 | Y2 |

****** horn-1: single line: decide / is / when
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

(head :: RelationalPredicate) WHEN (body :: AnyAll RelationalPredicate)

but also

X IS HornClauseRHS

| DECIDE | X | IS | Y | WHEN | Z | IS | Q | AND | P | > | NP |


****** horn-2: multiline: decide / is // when / is // and
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | X | IS | Y  |
| WHEN   | Z | IS | Q  |
| AND    | P | >  | NP |

****** horn-3: multiline: decide / is // when
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | X | IS | Y |     |   |   |    |
| WHEN   | Z | IS | Q | AND | P | > | NP |

BoolStructR should be (AND (z is q) (p gt np))

****** horn-3-or: decide, multi line 3, or
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-3-or.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

BoolStructR should be (OR (z is q) (p gt np))

| DECIDE | X | IS | Y |    |   |   |    |
| WHEN   | Z | IS | Q | OR | P | > | NP |

****** horn-4: decide, multi line 4
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | X |    |    |
| IS     | Y |    |    |
| WHEN   | Z | IS | Q  |
| AND    | P | >  | NP |

****** horn-5: decide, multi line 5
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-5.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | X |    |    |
| IS     | Y |    |    |
| WHEN   | Z | IS | Q  |
| OR     | P | >  | NP |

****** horn-6: binding
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-6.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

"OR" binds tighter than "AND", so we should have (and (or (z is q) (p > np))

| DECIDE | X   |    |       |
| IS     | Y   |    |       |
| WHEN   | Z   | IS | Q     |
| OR     | P   | >  | NP    |
| AND    | top | IS | level |

****** horn-7: simple define, multi line 7 with nested bool
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-7.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

"OR" binds tighter than "AND", so explicit nesting should yield (or (z is q) (and (p > np) (top IS level))

| DECIDE | X   |     |    |       |
| IS     | Y   |     |    |       |
| WHEN   | Z   | IS  | Q  |       |
| OR     | P   | >   | NP |       |
|        | AND | top | IS | level |

Explicit nesting only activates when there's a boolconnector after a newline. if the boolconnector is on the same line we keep going.

***** HornClauseRHS
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

something ... IS HornClauseRHS

ParamText <*> optional (pToken WHEN *> RelationalPredicate)

fragment of a HornClause with a constraint RelationalPredicate sans the X part

****** examples: HAS IS method definition in a type declaration
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

This is a speculative syntax, it may turn out to be too loose to work with.

| DECLARE |   | Round    | IS | A | Type   |        |   |      |                  |       |                  |
| HAS     |   | Player A | IS | A | Player |        |   |      |                  |       |                  |
|         |   | Player B | IS | A | Player |        |   |      |                  |       |                  |
|         | 1 | winner   | IS | A | Player |        |   |      |                  |       |                  |
|         |   |          | IS |   |        | Player | X | WHEN | Player X's throw | beats | Player Y's throw |

HAS (optional N) OtherVal TypeSig `indented0` IS HornClauseRHS

****** contexts
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

constitutive rule

| DECIDE | X | IS | Y | ... |

type DECLARE rule

| DECLARE | ... | HAS | something | IS | A | Something |
|         |     |     |           | IS |   | HornClauseRHS |

***** lots of variants on horn clauses

****** x is y when z or q
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-variant-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|      | X | IS | a relative   |
| WHEN | X | IS | an ancestor  |
| OR   | X | IS | a descendant |
| OR   | X | IS | a sibling    |


****** x is y means z or q
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-variant-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | X | IS | a relative   |
| MEANS | X | IS | an ancestor  |
| OR    | X | IS | a descendant |
| OR    | X | IS | a sibling    |

****** x means y when z
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-variant-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

nope.

****** x includes y when z
:PROPERTIES:
:TABLE_EXPORT_FILE: horn-variant-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|      | X | INCLUDES | Y            |
| WHEN | Y | IS       | an ancestor  |
| OR   | Y | IS       | a descendant |
| OR   | Y | IS       | a sibling    |

***** RelationalPredicate: IsRelation
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

MultiText (pToken IS) MultiText

| X | IS | HornClauseRHS |

used for equality and unification

****** simple relationalpredicate in a WHO
:PROPERTIES:
:TABLE_EXPORT_FILE: relpred-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | Person     |
| WHO   | degustates |
| MUST  | sing       |


***** RelationalPredicate: Constraint
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

MultiText RelToken MultiText

****** examples:

| P | > | NP |

| NOT | isMortal  |

| isMortal |

| degustates|

****** contexts

- part of a HornClause

***** RelationalPredicate: N-ary Predicate
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

ParamText list of words, untyped.

- Words obey the form   ~RecordName+ Predicate~
- where the ~Predicate~ is an n-ary predicate
- where n is the number of RecordNames preceding the Predicate

****** examples: unary predicate, type Bool

| DECIDE | Person | isMortal | WHEN | Person | isHuman |

****** examples: unary function, type Player

| DECLARE | Round | winner

****** contexts

- part of a HornClause

***** decision tables: ConstitutiveRule, Binary Predicate definition, explicit, infix

we should have support for multi-way define/decide IS/WHEN lines: a la

****** decision tables 1
:PROPERTIES:
:TABLE_EXPORT_FILE: multi-decide-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| GIVEN  | Sign1 |       | Sign2 | IS | A        | Sign |       |    |          |
| DECIDE | Sign1 | beats | Sign2 |    |          |      |       |    |          |
| IS     | TRUE  | WHEN  | Sign1 | IS | Rock     | AND  | Sign2 | IS | Scissors |
|        | "     | "     | "     | "  | Scissors | "    | "     | "  | Paper    |
|        | "     | "     | "     | "  | Paper    | "    | "     | "  | Rock     |

****** decision tables 2
:PROPERTIES:
:TABLE_EXPORT_FILE: multi-decide-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

without the IS TRUE

| GIVEN  | Sign1 |       | Sign2    | IS  | A     | Sign |          |   |   |
| DECIDE | Sign1 | beats | Sign2    |     |       |      |          |   |   |
| WHEN   | Sign1 | IS    | Rock     | AND | Sign2 | IS   | Scissors |   |   |
| "      | "     | "     | Scissors | "   | "     | "    | Paper    |   |   |
| "      | "     | "     | Paper    | "   | "     | "    | Rock     |   |   |

***** Binary Predicate definition, compact
:PROPERTIES:
:TABLE_EXPORT_FILE: beat-means.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

don't think we ever got around to testing this one.

|       | beats    |       |          |
| MEANS | Rock     | beats | Scissors |
|       | Scissors | beats | Rock     |
|       | Paper    | beats | Rock     |

***** Type Declaration
:PROPERTIES:
:TABLE_EXPORT_FILE: class-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECLARE | Class1         | IS AN        | Object  |         |
| HAS     | id             | IS AN        | Integer |         |
|         |                |              |         |         |
| DECLARE | Class2         | IS A         | Class1  |         |
| HAS     | firstname      | IS           | A       | String  |
|         | lastname       | IS           | A       | String  |
|         | office address |              |         |         |
|         | HAS            | line1        | ::      | String  |
|         |                | line2        | ::      | String  |
|         | bar address    | ::           | address |         |
|         | work address   | IS           | A       | address |
|         | HAS            | floor        | ::      | String  |
|         |                | company name | ::      | String  |
|         |                |              |         |         |
| DECLARE | address        |              |         |         |
| HAS     | line1          | ::           | String  |         |
|         | line2          | ::           | String  |         |

This example serves multiple tests:
- the interpreter should inherit line1 and line2 to "work address" and extend it with "floor" and "company name" attributes.

***** Financial Advisor
:PROPERTIES:
:TABLE_EXPORT_FILE: class-fa-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

this is indented deliberately to exercise the parser.

|   | DECLARE | FinancialStatus    | IS | ONE OF |                    | adequate | inadequate  |
|   | DECLARE | EarningsStatus     | IS | ONE OF |                    | steady   | unsteady    |
|   | DECLARE | InvestmentStrategy | IS | ONE OF | savings            | stocks   | combination |
|   |         |                    |    |        |                    |          |             |
|   | §§      | person type        |    |        |                    |          |             |
|   | DECLARE | Person             |    |        |                    |          |             |
|   | HAS     | dependents         | IS | A      | Number             |          |             |
|   |         | amountSaved        | IS | A      | Number             |          |             |
|   |         | earnings           | IS | A      | Number             |          |             |
|   |         | steadiness         | IS | A      | EarningsStatus     |          |             |
|   |         | income             | IS | A      | FinancialStatus    |          |             |
|   |         | savingsAccount     | IS | A      | FinancialStatus    |          |             |
|   |         | isDead             | IS | A      | Boolean            |          |             |
|   |         | spendthrift        | IS | A      | Boolean            |          |             |
|   |         | investment         | IS | AN     | InvestmentStrategy |          |             |

***** Financial Advisor decisions
:PROPERTIES:
:TABLE_EXPORT_FILE: class-fa-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| GIVEN  | p |                | IS | A                             | Person    |      |                |    |   |            |
| DECIDE | p | investment     | IS | savings                       | WHEN      | p    | savingsAccount | IS |   | inadequate |
|        | p | "              | "  | stocks                        | WHEN      | p    | savingsAccount | IS |   | adequate   |
|        |   |                |    |                               | AND       | p    | income         | IS |   | adequate   |
|        | p | "              | "  | combination                   | OTHERWISE |      |                |    |   |            |
|        | p | minSavings     | IS | p's dependents                | *         | 5000 |                |    |   |            |
|        | p | savingsAccount | IS | adequate                      | WHEN      | p    | amountSaved    | >  | p | minSavings |
|        | p | "              | "  | inadequate                    | OTHERWISE |      |                |    |   |            |
|        | p | minIncome      | IS | 15000 + 4000 * p's dependents |           |      |                |    |   |            |
|        | p | income         | IS | adequate                      | WHEN      | p    | earnings       | >  | p | minIncome  |
|        |   |                |    |                               | AND       | p    | steadiness     | IS |   | steady     |
|        | p | blah           | IS | 42                            |           |      |                |    |   |            |




p minIncome  IS 15000 + 4000 * (p's dependents) + 1000 * (p's dependents) / 2 + 500 * (p's semidependents) / 3

Map Term Lambda = zip (nub terms, [1..])

\l1 l2 -> 15000 + 4000 * x + 1000 * x / 2 + 500 * y / 3

minIncome(MI, D, SD) :- MI IS 15000 + 4000 * D + 1000 * D / 2 + 500 * SD / 3.


****** a scenario would look like:
:PROPERTIES:
:TABLE_EXPORT_FILE: class-fa-2-scenario.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

the HAS isn't parseable yet. [TODO]

| GIVEN  | p   | IS A          | Person |         |                |
|        | HAS | dependents    | IS     |       5 |                |
|        |     | earnings      | IS     |   10000 |                |
|        |     | savingsAmount | IS     |  100000 |                |
| EXPECT | p   | investment    | IS     | savings | -- or whatever |

***** the CoreL4 encoding of the AXA case uses class extensions
:PROPERTIES:
:TABLE_EXPORT_FILE: class-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECLARE |                |       | Person         |         |
| DECLARE | Passenger      | IS A  | Person         |         |
| DECLARE | Driver         | IS A  | Passenger      |         |
| DECLARE |                |       | GeneralVehicle |         |
| HAS     | vehicleAge     | IS AN | Integer        |         |
|         | vehicleLength  | IS A  | Float          |         |
| DECLARE | Vehicle        | IS A  | GeneralVehicle |         |
| DECLARE |                |       | Event          |         |
| DECLARE | BreakdownCause | IS A  | Event          |         |
| DECLARE |                |       | Location       |         |
| DECLARE |                |       | Surface        |         |
| ;;      |                |       |                |         |
| GIVEN   | location       | IS A  | Location       |         |
|         | surface        | IS A  | Surface        |         |
| DECIDE  | isIn           |       |                |         |
| WHEN    | location       | IN    | surface        |         |
| ;;      |                |       |                |         |
| DECLARE | Vehicles       | IS    | LIST1          | Vehicle |

***** HasRelation


*** sameOrNextLine -s same
:PROPERTIES:
:TABLE_EXPORT_FILE: sameornext-1-same.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECLARE | Potato | HAS | genus | species |

*** sameOrNextLine - next
:PROPERTIES:
:TABLE_EXPORT_FILE: sameornext-2-next.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECLARE | Potato |         |
| HAS     | genus  | species |

*** sameOrNextLine - left a bit
:PROPERTIES:
:TABLE_EXPORT_FILE: sameornext-3-dnl.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|     | DECLARE | Potato  |   |
| HAS | genus   | species |   |

*** sameOrNextLine - next right a bit
:PROPERTIES:
:TABLE_EXPORT_FILE: sameornext-4-right.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   | DECLARE | Potato |       |         |
|   |         | HAS    | genus | species |
*** ampersand: |&| declare with inline nestedHorn
:PROPERTIES:
:TABLE_EXPORT_FILE: declare-nestedhorn-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECLARE | Potato |                    |         |
|         | HAS    | genus              | species |
|         |        | MEANS              |         |
|         |        | some Linnaen thing |         |


*** ampersand: |&| too far left -- should fail
:PROPERTIES:
:TABLE_EXPORT_FILE: ampersand-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|              | Potato |         |
| too far left | genus  | species |

*** ampersand: |&| just underneath -- should parse
:PROPERTIES:
:TABLE_EXPORT_FILE: ampersand-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   | Potato |         |
|   | genus  | species |

*** ampersand: |&| to the right -- should parse
:PROPERTIES:
:TABLE_EXPORT_FILE: ampersand-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   | Potato |       |         |
|   |        | genus | species |

*** ampersand: |&| to the right -- should parse
:PROPERTIES:
:TABLE_EXPORT_FILE: ampersand-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

similar to the situation in pdpadbno, where we have SOMETHING occurred

|   | Potato |       |         | uncaptured |
|   |        | genus | species |            |

we want the SOMETHING to have a MEANS under it, but the "occurred" should not.

we'll leave this as a [TODO] for now.

** Keywords

*** DECIDE

followed by

HornClause



** Tests
*** Not a Rule
:PROPERTIES:
:TABLE_EXPORT_FILE: notarule-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|            | some random text | counts as not a rule |
| moo        | bar              | baz                  |
|            |                  |                      |
| blank line |                  |                      |
|            | and more!        |                      |

*** Mixed Nots
:PROPERTIES:
:TABLE_EXPORT_FILE: notarule-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|            | some random text | counts as not a rule |
| moo        | bar              | baz                  |
|            |                  |                      |
| blank line |                  |                      |
|            | and more!        |                      |
|            |                  |                      |
| DEEM       | tomato           |                      |
| IS         | vegetable        |                      |
|            |                  |                      |
| some       | more             | blank                |
|            |                  |                      |
| DEEM       | potato           |                      |
| IS         | vegetable        |                      |
| DEEM       | leek             |                      |
| IS         | vegetable        |                      |
|            |                  |                      |

*** one-liners

**** deem ... is ...
:PROPERTIES:
:TABLE_EXPORT_FILE: oneliner-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DEEM | potato | IS | vegetable |
| DEEM | leek   | IS | vegetable |

**** deem with ditto
:PROPERTIES:
:TABLE_EXPORT_FILE: oneliner-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DEEM | potato | IS | vegetable |
| "    | leek   | "  | vegetable |

*** indented boolean expression under preamble WHO
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/indented-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

walks OR runs OR eats OR (drinks AND swallows)

|   | EVERY | person |          |            |
|   | WHO   | walks  |          |            |
|   | OR    | runs   |          |            |
|   | OR    | eats   |          | // comment |
|   | OR    |        | drinks   |            |
|   |       | AND    | swallows |            |
|   | MUST  |        |          |            |
|   | ->    | sing   |          |            |

*** indented boolean expression (with checkboxes)
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/indented-1-checkboxes.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

Google Sheets exports checkboxes as booleans. The parser should ignore them.

|   | EVERY |       | person |          |            |
|   | WHO   | TRUE  | walks  |          |            |
|   | OR    | FALSE | runs   |          |            |
|   | OR    | FALSE | eats   |          | // comment |
|   | OR    |       | TRUE   | drinks   |            |
|   |       | AND   | FALSE  | swallows |            |
|   | MUST  |       |        |          |            |
|   | ->    | FALSE | sing   |          |            |

*** simple regulative rule for the Must Sing example
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/mustsing-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §     | Matt Wadd's Rule |
| EVERY | Person           |
| WHO   | walks            |
| AND   | eats             |
| OR    | drinks           |
| MUST  | sing             |

*** simple regulative rule for the Must Sing example with a deadline on the MUST
:PROPERTIES:
:TABLE_EXPORT_FILE: mustsing-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §     | Matt Wadd's Rule           |    |             |   |
| EVERY | Person                     | :: | Singaporean |   |
| WHO   | walks                      |    |             |   |
| AND   | eats                       |    |             |   |
| OR    | drinks                     |    |             |   |
| IF    | the moon is full           |    |             |   |
| WHEN  | the king is in a good mood |    |             |   |
| MUST  | sing                       |    |             |   |

*** simple regulative rule for the Must Sing example with a deadline on a separate line
:PROPERTIES:
:TABLE_EXPORT_FILE: mustsing-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §      | Matt Wadd's Rule |      |
| EVERY  | Person           |      |
| WHO    | walks            |      |
| AND    | eats             |      |
| OR     | drinks           |      |
| MUST   | sing             |      |
| BEFORE | 30               | days |

*** simple constitutive rule
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/simple-constitutive-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

defined terms are T-shaped rules

this should get picked up by the pConstitutiveRule and rewritten to Hornlike

|       | degustates |
| MEANS | eats       |
| OR    | drinks     |

#+begin_src prolog
  degustates(X) :- eats(X).
  degustates(X) :- drinks(X).
#+end_src

*** simple constitutive rule (with checkboxes)
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/simple-constitutive-1-checkboxes.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

...ignoring checkboxes...

|   |   |       |      |            |   |   |
|   |   |       |      | degustates |   |   |
|   |   | MEANS | TRUE | eats       |   |   |
|   |   | OR    | TRUE | drinks     |   |   |
|   |   |       |      |            |   |   |

*** indented inline constitutive rule
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/indented-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

This has the same meaning as the original Waddington example, except the "eats or drinks" is labelled as the defined term "degustates". And we change "drinks" to "imbibes" ...

| EVERY | person     |         |
| WHO   | walks      |         |
| AND   | degustates |         |
|       | MEANS      | eats    |
|       | OR         | imbibes |
| MUST  |            |         |
| ->    | sing       |         |

We parse this into a tree of rules; other rules are now welcome to refer to this defined term as well.

What does "imbibes" mean, anyway?

*** multiple nestings
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/indented-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

And we further nest a definition for "imbibes".

| EVERY | person     |         |          |
| WHO   | walks      |         |          |
| AND   | degustates |         |          |
|       | MEANS      | eats    |          |
|       | OR         | imbibes |          |
|       |            | MEANS   | drinks   |
|       |            | AND     | swallows |
|       |            | OR      | spits    |
| MUST  | sing       |         |          |

We parse this into a tree of rules; other rules are now welcome to refer to this defined term as well.

Note the defined terms in this example have moved one cell left to more natural positions.

*** what happens if everything is on one line?
:PROPERTIES:
:TABLE_EXPORT_FILE: experiment-oneline.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   | degustates | MEANS | eats | AND | drinks | OR | farts |

doesn't work

*** Multiple Preambles and BoolStructs
:PROPERTIES:
:TABLE_EXPORT_FILE: multiple-preambles.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

Preambles are:
- WHO
- WHEN
- IF
- UNLESS

**** Subject Qualifier BoolStructs

Immediately after the PARTY or EVERY line, a single WHO preamble may appear, followed by a BoolStruct. The BoolStruct applies to the entity who is the subject of the rule.

We have seen this form above.

**** General Boolstructs

Anywhere else in the stanza, a WHEN, IF, or UNLESS preamble, may appear, followed by a BoolStruct. Such BoolStructs apply generally -- they do not refer to the entity.

Below we use pilcrows to set off two stanzas which are identical but for permutation.

| EVERY  | person              |   |       |                     |
| WHO    | walks               |   |       |                     |
| AND    | eats                |   |       |                     |
| OR     | drinks              |   |       |                     |
| MUST   |                     |   |       |                     |
| WHEN   | Saturday            |   |       |                     |
| ->     | sing                |   |       |                     |
|        |                     |   |       |                     |
| EVERY  | person              |   |       |                     |
| WHO    | walks               |   |       |                     |
| AND    | eats                |   |       |                     |
| OR     | drinks              |   |       |                     |
| MUST   |                     |   |       |                     |
| ->     | sing                |   |       |                     |
| UNLESS | quietHours          |   |       |                     |
|        |                     |   |       |                     |
| EVERY  | person              | ¶ | EVERY | person              |
| WHO    | walks               | ¶ | WHO   | walks               |
| AND    | eats                | ¶ | AND   | eats                |
| OR     | drinks              | ¶ | OR    | drinks              |
| MUST   |                     | ¶ | MUST  |                     |
| IF     | the King so desires | ¶ | ->    | sing                |
| ->     | sing                | ¶ | IF    | the King so desires |
|        |                     |   |       |                     |
| EVERY  | person              |   |       |                     |
| WHO    | walks               |   |       |                     |
| AND    | eats                |   |       |                     |
| OR     | drinks              |   |       |                     |
| MUST   |                     |   |       |                     |
| IF     | the King wishes     |   |       |                     |
| ->     | sing                |   |       |                     |
| UNLESS | the Queen forbids   |   |       |                     |
|        |                     |   |       |                     |


*** different kinds of conditions
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/if-king-wishes-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          |    |                                                     |
| WHO   | walks           |    |                                                     |
| AND   | eats            |    |                                                     |
| MUST  |                 |    |                                                     |
| IF    | the King wishes | // | scope quantification slightly different vs 4        |
| ->    | sing            | // | suggests that the King is consulted for each person |

*** with multiple preambleBoolStructPs
:PROPERTIES:
:TABLE_EXPORT_FILE: if-king-wishes-queen.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person                   |
| WHO   | walks                    |
| AND   | eats                     |
| MUST  |                          |
| IF    | the King wishes          |
| WHEN  | the Queen is not looking |
| ->    | sing                     |

*** in a different order 2
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/if-king-wishes-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          |   |   |
| WHO   | walks           |   |   |
| AND   | eats            |   |   |
| MUST  |                 |   |   |
| ->    | sing            |   |   |
| IF    | the King wishes |   |   |

*** in a different order again 3
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/if-king-wishes-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          |   |   |
| WHO   | walks           |   |   |
| AND   | eats            |   |   |
| IF    | the King wishes |   |   |
| MUST  |                 |   |   |
| ->    | sing            |   |   |

*** in a different order again 4
:PROPERTIES:
:TABLE_EXPORT_FILE: if-king-wishes-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

Let's not allow this form:

| IF    | the King wishes | // | suggests that the King is consulted once, for all people |
| EVERY | person          |    |                                                          |
| WHO   | walks           |    |                                                          |
| AND   | eats            |    |                                                          |
| MUST  |                 |    |                                                          |
| ->    | sing            |    |                                                          |

Because this is really more of a meta-rule situation.

| IF   | the King wishes |        | // we could call this a meta-rule relation |
| THEN | EVERY           | person |                                            |
|      | WHO             | walks  |                                            |
|      | AND             | eats   |                                            |
|      | MUST            |        |                                            |
|      | ->              | sing   |                                            |

Let's not support this case 4 until we have a more principled approach to meta-rule relationships. Then we can put in IF/THEN/ELSE for a closed-world binary logic? and IF/THEN/ELSE/SHRUG for a Maybe Ternary lol

*** chained regulatives
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          |       |        |        |
| WHO   | walks           |       |        |        |
| AND   | eats            |       |        |        |
| MUST  |                 |       |        |        |
| IF    | the King wishes |       |        |        |
| ->    | sing            |       |        |        |
| HENCE | PARTY           | King  |        |        |
|       | MAY             | pay   |        |        |
|       | AFTER           | 20    | min    |        |
| LEST  | Singer          | MUST  | BEFORE | 1 | supper |
|       |                 | ->    | pay    |        |

**** do the individual components work?

do the individual components work?

***** the king part
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives-part1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| PARTY | King |     |
| MAY   | pay  |     |
| AFTER | 20   | min |

***** the singer part
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives-part2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| Singer | MUST | BEFORE | 1 | supper |
|        | ->   | pay    |   |        |

***** Just an Action
:PROPERTIES:
:TABLE_EXPORT_FILE: action-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| -> | win |

***** A Bigger Action
:PROPERTIES:
:TABLE_EXPORT_FILE: action-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| -> | win | gloriously |

*** chained regulatives with action params
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/action-params-singer.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| Singer | MUST | BEFORE | 1        | supper |
|        | ->   | pay    |          |        |
|        |      | to     | the King |        |
|        |      | amount | $20      |        |

this causes problems for the Parser because we see the word "pay" as a Label.

We need a special case to handle it.

*** Alternative Arrangements of Temporals and Actions
**** may pay after time
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives-part1-alternative-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| PARTY | King  |  |
| MAY   | pay   |  |
| AFTER | 20    | min |

**** may after time pay
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives-part1-alternative-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| PARTY | King  |    |     |
| MAY   | AFTER | 20 | min |
| ->    | pay   |    |     |

**** party after may time
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives-part1-alternative-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| PARTY | King  |     |
| AFTER | 20    | min |
| MAY   | pay   |     |

**** party may, no time
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/chained-regulatives-part1-alternative-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| PARTY | King |
| MAY   | pay  |

*** simple natural language aliases on the same line
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/nl-aliases.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          | AKA | singer |
| WHO   | walks           |     |        |
| AND   | eats            |     |        |
| MUST  |                 |     |        |
| IF    | the King wishes |     |        |
| ->    | sing            |     |        |

*** simple natural language aliases on the next line
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing/nl-aliases-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          |        |
|       | AKA             | singer |
| WHO   | walks           |        |
| AND   | eats            |        |
| MUST  |                 |        |
| IF    | the King wishes |        |
| ->    | sing            |        |

*** increasingly complex WHO fields

we're switching from RPParamText to MultiTerm to keep things simpler

**** single-word WHO should be an RPMT
:PROPERTIES:
:TABLE_EXPORT_FILE: who-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |
| WHO   | eats   |
| MUST  |        |
| ->    | sing   |

**** two-word WHO should also be an RPMT
:PROPERTIES:
:TABLE_EXPORT_FILE: who-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |        |
| WHO   | eats   | rudely |
| MUST  |        |        |
| ->    | sing   |        |


**** three-word WHO should also be an RPMT
:PROPERTIES:
:TABLE_EXPORT_FILE: who-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |         |         |
| WHO   | eats   | without | manners |
| MUST  |        |         |         |
| ->    | sing   |         |         |

**** three-word WHO with a proper relation should be a Constraint
:PROPERTIES:
:TABLE_EXPORT_FILE: who-5.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |    |      |
| WHOSE | eyes   | IS | blue |
| MUST  |        |    |      |
| ->    | sing   |    |      |

**** TODO WHO with a recursive BoolStructR
:PROPERTIES:
:TABLE_EXPORT_FILE: who-6.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |    |      |
| WHO   | eyes   | IS | blue |
| MUST  |        |    |      |
| ->    | sing   |    |      |

*** vague temporal spec
:PROPERTIES:
:TABLE_EXPORT_FILE: t-vaguely.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person          | AKA | singer |
| WHO   | walks           |     |        |
| AND   | eats            |     |        |
| MUST  | sooner or later |     |        |
| IF    | the King wishes |     |        |
| ->    | sing            |     |        |

*** stanzas interrupted by blank lines
:PROPERTIES:
:TABLE_EXPORT_FILE: blank-lines.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|                                                     |                 |          |        |
| A paragraph with irrelevant text should be ignored. |                 | Like so. |        |
|                                                     |                 |          |        |
|                                                     |                 |          |        |
| EVERY                                               | person          | AKA      | singer |
| WHO                                                 | walks           |          |        |
| AND                                                 | eats            |          |        |
| MUST                                                |                 |          |        |
|                                                     |                 |          |        |
|                                                     |                 |          |        |
| IF                                                  | the King wishes |          |        |
| ->                                                  | sing            |          |        |

*** qualifying person
:PROPERTIES:
:TABLE_EXPORT_FILE: qualifying-person.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | Qualifying Person | AKA   | QP |
|       | MEANS             | walks |    |
|       | AND               | eats  |    |
| MUST  |                   |       |    |
| ->    | sing              |       |    |

*** legislative source citations
:PROPERTIES:
:TABLE_EXPORT_FILE: source-citations.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| (Act 1) | EVERY | person          |   |
|         | WHO   | walks           |   |
| (Act 2) | AND   | eats            |   |
|         | MUST  |                 |   |
| (Act 3) | IF    | the King wishes |   |
|         | ->    | sing            |   |

*** Stanza Extraction
:PROPERTIES:
:TABLE_EXPORT_FILE: extract-potatoes.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

Suppose we downloaded as CSV an entire spreadsheet containing multiple stanzas. How do parse only the relevant bits?

|   | EVERY    | person |                |          |         |   |   |
|   | WHO      | walks  |                |          |         |   |   |
|   | AND      | eats   |                |          |         |   |   |
|   | OR       | drinks |                |          |         |   |   |
|   | MUST     |        |                |          |         |   |   |
|   | ->       | sing   |                |          |         |   |   |
|   |          |        |                |          |         |   |   |
|   | we add a | line   | to separate    | the      | stanzas |   |   |
|   |          |        |                |          |         |   |   |
|   |          | EVERY  | person         |          |         |   |   |
|   |          | MAY    | AFTER          | lunch    |         |   |   |
|   |          | ->     | eat potato     |          |         |   |   |
|   |          | WHEN   | tasty(potato)  |          |         |   |   |
|   |          | UNLESS | green(potato)  |          |         |   |   |
|   |          |        |                |          |         |   |   |
|   | we add a | line   | to separate    | the      | stanzas |   |   |
|   |          |        |                |          |         |   |   |
|   | You      | MUST   | BEFORE         | midnight |         |   |   |
|   |          | ->     | discard potato |          |         |   |   |
|   |          | WHEN   | green(potato)  |          |         |   |   |
|   |          |        |                |          |         |   |   |
|   |          |        |                |          |         |   |   |


*** The ~Unless~ preamble
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

**** UNLESS for entity qualification vs for regular conditionals

The preamble ~WHO~ introduces a Boolean structure which qualifies the party.

The preamble ~MEANS~ ends up in the relationalpredicate in the hHead.

The preamble ~IF~ introduces a Boolean structure which qualifies preconditions generally. It goes to the hBody.

The connector ~UNLESS~ is defined as ~AND NOT~, so it follows whatever preamble preceded it.

**** Unless in the head
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing-means/bob-tail-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|        | Bob's your uncle             |
| MEANS  | Bob is your mother's brother |
| OR     | Bob is your father's brother |
| UNLESS | Bob is just a family friend  |

is ((morbror or farbror) and (not estranged))

**** TODO Unless in the tail
:PROPERTIES:
:TABLE_EXPORT_FILE: bob-tail-1-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

need to be sure this is in the test suite -- does Spec.hs point to this?

|        | Bob's your uncle             |           |     |
| MEANS  | Bob is your mother's brother |           |     |
| OR     | Bob is your father's brother |           |     |
| WHEN   | generally                    | TYPICALLY | yes |
| UNLESS | Bob is estranged             |           |     |

is (morbror or farbror)
if (not estranged))

**** You can't have an UNLESS being the head of a constitutive rule -- it has to be MEANS or WHEN or IS :shouldfail:
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing-means/bob-head-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bob's your uncle |                  |             |
| MEANS | NOT              | Bob is estranged |             |
|       |                  | OR               | Bob is dead |

hHead: is (not (estranged or dead))

**** TODO note hHead vs hBody
:PROPERTIES:
:TABLE_EXPORT_FILE: bob-head-1-c.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

need to be sure this is in the test suite -- does Spec.hs point to this?

unless follows the and/or/not

|        | Bob's your uncle             |             |
| MEANS  | Bob is your mother's brother |             |
| OR     | Bob is your father's brother |             |
| UNLESS | Bob is estranged             |             |
|        | OR                           | Bob is dead |

if (not (estranged or dead))
**** more explicit indentation, head                                                   :expected:
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing-means/bob-head-1-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

indenting the "Bob is estranged" term to the right of the OR below it, has the most righteous rectitude.

|       | Bob's your uncle |    |                  |
| MEANS | NOT              |    | Bob is estranged |
|       |                  | OR | Bob is dead      |

if (not (estranged or dead))
**** TODO more explicit indentation, body                                              :expected:
:PROPERTIES:
:TABLE_EXPORT_FILE: bob-head-1-d.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

need to be sure this is in the test suite -- does Spec.hs point to this?

|      | Bob's your uncle |    |                  |
| WHEN | NOT              |    | Bob is estranged |
|      |                  | OR | Bob is dead      |

if (not (estranged or dead))

note this goes into the hBody instead of the hHead.

**** more explicit indentation, unless in the body                                     :expected:
:PROPERTIES:
:TABLE_EXPORT_FILE: bob-head-1-e.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|        | Bob's your uncle             |
| MEANS  | Bob turns up at Thanksgiving |
| WHEN   | Bob is dead                  |
| OR     | Bob is blue                  |
| UNLESS | Bob is immortal              |

is thanksgiving
if (not immortal and (dead or blue))

note the unless goes into the hBody instead of the hHead.

**** less explicit indentation                                                         :expected:
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing-means/bob-head-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bob's your uncle |                  |
| MEANS | NOT              | Bob is estranged |
|       | OR               | Bob is dead      |

is (not estranged) or dead)

**** but indentation doesn't go backwards
:PROPERTIES:
:TABLE_EXPORT_FILE: Parsing/megaparsing-means/bob-head-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bob's your uncle |                  |
| MEANS | NOT              | Bob is estranged |
| OR    | Bob is dead      |                  |

is ((not estranged) or dead))

**** combined with other connectors
:PROPERTIES:
:TABLE_EXPORT_FILE: bob-head-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | Bob's your uncle            |             |                  |
| MEANS | Bob's your mother's brother |             |                  |
| OR    | Bob's your father's brother |             |                  |
| AND   |                             | NOT         | Bob is estranged |
|       | OR                          | Bob is dead |                  |



**** Unless as the only term in a regulative rule
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person         |
| MUST   | sing           |
| UNLESS | day of silence |

**** Unless as the first term in a regulative rule
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person          |
| MUST   | sing            |
| UNLESS | day of silence  |
| IF     | the king wishes |

The intepreter combines two conditions into one: ~if ((not (day of silence)) && (the king wishes))~

**** Unless as the second term in a regulative rule
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person          |
| MUST   | sing            |
| IF     | the king wishes |
| UNLESS | day of silence  |

same as above

**** Unless as a separated first term in a regulative rule
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person          |
| UNLESS | day of silence  |
| MUST   | sing            |
| IF     | the king wishes |

**** Unless as a separated second term in a regulative rule
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-5.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person          |
| IF     | the king wishes |
| MUST   | sing            |
| UNLESS | day of silence  |

**** Unless preambles an OR
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-6.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person          |
| IF     | the king wishes |
| MUST   | sing            |
| UNLESS | day of silence  |
| OR     | day of mourning |

**** Unless preambles an AND
:PROPERTIES:
:TABLE_EXPORT_FILE: unless-regulative-7.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person                   |
| IF     | the king wishes          |
| MUST   | sing                     |
| UNLESS | day of mourning          |
| AND    | mourning forbids singing |

*** NOT is a thing

**** Should be the same as an IF NOT (joined):
:PROPERTIES:
:TABLE_EXPORT_FILE: ifnot-1-joined.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person         |
| MUST   | sing           |
| IF NOT | day of silence |

**** Should be the same as an IF NOT (separated):
:PROPERTIES:
:TABLE_EXPORT_FILE: ifnot-2-separate.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |                |
| MUST  | sing   |                |
| IF    | NOT    | day of silence |

How does this interact with our indentation syntax?

**** Maybe IF NOT indentation binds looser than AND
:PROPERTIES:
:TABLE_EXPORT_FILE: ifnot-3-undefined.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |                         |         |
| MUST  | sing   |                         |         |
| IF    | NOT    | day of silence          |         |
|       | AND    | observance is mandatory |         |

This could trigger an error, forcing the user to choose one of the explicit forms below.

(Right now it matches 4 immediately below, we are being lenient.)

If we get around to https://github.com/smucclaw/sandbox/issues/33 we can revisit this and outlaw it.

**** Maybe IF NOT indentation is required to appear at its own level to reduce human error
:PROPERTIES:
:TABLE_EXPORT_FILE: ifnot-4-indentation-explicit.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person |     |                         |
| MUST  | sing   |     |                         |
| IF    | NOT    |     | day of silence          |
|       |        | AND | observance is mandatory |

We already squash AND and OR to the same column, even though they have different precedence, so maybe we should force NOT to be explicit.

**** Maybe IF NOT indentation is required to appear at its own level to reduce human error
:PROPERTIES:
:TABLE_EXPORT_FILE: ifnot-5-indentation-explicit.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | person      |                |
| MUST  | sing        |                |
| IF    | NOT         | day of silence |
| AND   | day of song |                |

Moving the AND to the level of the IF is an accepted and common form.



*** The semantics of GIVEN and HAVING

Currently GIVEN is a boolstruct / boolrules thingy that has happened previously

maybe we want it to be a ParamText instead?

**** Given in a simple constitutive rule
:PROPERTIES:
:TABLE_EXPORT_FILE: given-consti-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

We look back in the history:

|       | songFee    |    |      |
| GIVEN | songLength |    |      |
| WHEN  | songLength | >= | 2min |
| IS    | $200       |    |      |
|       |            |    |      |
| but   |            |    |      |
|       |            |    |      |
|       | songFee    |    |      |
| GIVEN | songLength | <  | 2min |
| IS    | $100       |    |      |

**** HAVING
:PROPERTIES:
:TABLE_EXPORT_FILE: /dev/null
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

How about we then make HAVING be the ParamText that refers to something in the trace also?

| GIVEN  | tax rate   | :: | Number |
|        | income     | :: | Number |
|        |            |    |        |
| DEFINE | payableTax | :: | Float  |
| IS     | tax rate   | *  | income |

***** Simple Having
:PROPERTIES:
:TABLE_EXPORT_FILE: having-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | Party      |                  |      |
| HAVING | sung       |                  |      |
|        | songLength | >=               | 2min |
| MAY    | claim      | songFee          |      |
|        | amount     | $10 * songLength |      |

*** Tracking citations and sources

In the spreadsheet we allow a prefix on each line that shows the source of the legislation.

To handle this we may need to augment our types so that each bit of logic can be annotated with a source Text.Text.

*** very simple primitives

**** just a single pOtherVal
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-pOtherVal.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| this is a string |

**** just a single pOtherVal indented a bit
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-pOtherVal-indented.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   |   | this is a string |   |   |

**** just a simple number
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-pNumber.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| 42 |

*** less complex primitives

**** number followed by a string, over multiple lines
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-number-string-multi.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|  42 |
| boo |
**** number followed by a string, on the same line
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-number-string-single.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| 42 | boo |

**** number followed by a string, on the same line, 1
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-number-string-single-indented-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| 42 |   | boo |

**** number followed by a string, on the same line, 2
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-number-string-single-indented-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   | 42 |   | boo |

**** number followed by a string, on the same line, 3
:PROPERTIES:
:TABLE_EXPORT_FILE: primitive-number-string-single-indented-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   | 42 |   |   | boo |

*** compound expressions
**** a pair of numbers one after the other, unindented
:PROPERTIES:
:TABLE_EXPORT_FILE: compound-pairOfNumbers-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| 42 | 43 |
**** a pair of numbers one after the other, indented
:PROPERTIES:
:TABLE_EXPORT_FILE: compound-pairOfNumbers-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   |   | 42 | 43 |


**** a pair of numbers one after the other, indented annoyingly
:PROPERTIES:
:TABLE_EXPORT_FILE: compound-pairOfNumbers-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   |   | 42 |   |   | 43 |

**** a pair of numbers one after the other, indented annoyingly, followed by an otherval
:PROPERTIES:
:TABLE_EXPORT_FILE: compound-pairOfNumbers-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|   |   | 42 |   |   | 43 |   | my string |

** Ontology
:PROPERTIES:
:TABLE_EXPORT_FILE: define-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

this doesn't actually compile, i think the syntax has changed

|   | DEFINE | Chirality |       |           |           |
|   | ONE OF | Left      |       |           |           |
|   |        | Right     |       |           |           |
|   |        |           |       |           |           |
|   | so     | now we    | can   |           |           |
|   |        |           |       |           |           |
|   | DEFINE | Hand      | ::    | Chirality |           |
|   |        |           |       |           |           |
|   | ;      |           |       |           |           |
|   |        |           |       |           |           |
|   | DEFINE | Arm       | ::    | Chirality |           |
|   |        |           |       |           |           |
|   | ;      |           |       |           |           |
|   |        |           |       |           |           |
|   | DEFINE | Sign      |       |           |           |
|   | ONE OF | Rock      |       |           |           |
|   |        | Scissors  |       |           |           |
|   |        | Paper     |       |           |           |
|   |        |           |       |           |           |
|   | ;      |           |       |           |           |
|   |        |           |       |           |           |
|   | DEFINE | Name      | IS    | A         | String    |
|   |        |           |       |           |           |
|   | ;      |           |       |           |           |
|   |        |           |       |           |           |
|   | DEFINE | BirthYear | IS    | A         | Number    |
|   |        |           |       |           |           |
|   | ;      |           |       |           |           |
|   |        |           |       |           |           |
|   | DEFINE | Player    | IS    | AN        | Entity    |
|   | HAS    | yearBorn  | IS    | A         | BirthYear |
|   |        | fullName  | IS    | A         | Name      |
|   |        | dynamic   | --    | untyped!  |           |
|   |        |           |       |           |           |
|   | ;      |           |       |           |           |
|   |        |           |       |           |           |
|   |        |           | beats |           |           |
|   | MEANS  | rock      | beats | scissors  |           |
|   |        | paper     | beats | rock      |           |
|   |        | scissors  | beats | paper     |           |
|   |        |           |       |           |           |


*** GIVEN ... DEEM
:PROPERTIES:
:TABLE_EXPORT_FILE: define-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

optional Given ParamText
permute
  required Deem ParamText
  optional BoolStruct [If,When]

|   |        |               |       |    |      |
|   | GIVEN  | x             | y     | :: | Sign |
|   | DECIDE | x             | beats | y  |      |
|   | WHEN   | x == Rock     |       |    |      |
|   | AND    | y == Scissors |       |    |      |

#+begin_src prolog
  % direct awkward translation
  beats(X,Y) :- X IS rock, Y IS scissors.

  % idiomatically
  beats(rock,scissors).
#+end_src

creates a Constitutive Rule; the "assig" (assignment) is "deem".

*** Constitutive Rule syntax

Normally we have X MEANS Y

Y could be a boolstruct

#+begin_example
  degustates
       MEANS eats
          OR drinks
#+end_example

but it could be something else:

#+begin_example
    Maximum Number Of People AKA MaxPeople
                       MEANS 500
#+end_example

so let's try parsing as a boolrule and if that doesn't work we just shoehorn it into a paramtext.

*** More Deem Syntax
:PROPERTIES:
:TABLE_EXPORT_FILE: define-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

what if we say
|       |         |   |    |        |
| GIVEN | x       | y | :: | Number |
| DEEM  | product |   |    |        |
| MEANS | x       | * | y  |        |
|       |         |   |    |        |



*** defeating
:PROPERTIES:
:TABLE_EXPORT_FILE: define-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:


| GIVEN | Player1        |         |   | Player2        | :: | Player |
| DEEM  | Player1        | defeats |   | Player2        |    |        |
| WHEN  | Player1.choice | beats   |   | Player2.choice |    |        |

*** Pilcrows
:PROPERTIES:
:TABLE_EXPORT_FILE: pilcrows-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY  | person         |  | ¶ | | EVERY | person      |                |
| MUST   | sing           |  | ¶ | | MUST  | sing        |                |
| IF NOT | day of silence |  | ¶ | | IF    | NOT         | day of silence |
|        |                |  | ¶ | | AND   | day of song |                |

**** Harder Pilcrows
:PROPERTIES:
:TABLE_EXPORT_FILE: pilcrows-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:


| (Act §26C.3)   | EVERY  | Data Intermediary                                                                     |                                            | AKA | You |   | ¶ | (Act §26E)   | EVERY | Data Intermediary                                                               |                                             | AKA | You |
| (Act §26C.3)   | UNLESS | you are processing personal data on behalf of and for the purposes of a public agency |                                            |     |     |   | ¶ | (Act §26E)   | WHICH | processes personal data on behalf of and for the purposes of a public agency    |                                             |     |     |
| (Act §26C.2)   | MUST   | without undue delay                                                                   |                                            |     |     |   | ¶ | (Act §26E)   | MUST  | without undue delay                                                             |                                             |     |     |
| (Act §26C.2)   | UPON   | becoming aware a data breach involving a client Organisation may have occurred        |                                            |     |     |   | ¶ | (Act §26C.2) | UPON  | becoming aware a data breach involving a client public agency may have occurred |                                             |     |     |
| (Act §26C.1)   | WHEN   | the data breach occurs on or after the date of commencement of PDP(A)A 2020 §13       |                                            |     |     |   | ¶ |              |       |                                                                                 |                                             |     |     |
| (Act §26C.3.a) | ➔      | notify                                                                                | the Organisation for which you act as a DI |     |     |   | ¶ | (Act §26E)   | ➔     | notify                                                                          | the public agency for which you act as a DI |     |     |
|                |        |                                                                                       |                                            |     |     |   |   |              |       |                                                                                 |                                             |     |     |
|                |        |                                                                                       |                                            |     |     |   |   |              |       |                                                                                 |                                             |     |     |

*** 1: Rule Groups and Rule Labels                                                      :pdpadbno:
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§    | Assess                                                                          |                                   |                                  |                   |     |
| EVERY | Organisation                                                                    |                                   |                                  | AKA               | You |
| WHO   | is                                                                              | not                               | a Public Agency                  |                   |     |
| MUST  | WITHIN                                                                          | 30                                | days                             |                   |     |
| UPON  | becoming aware a data breach may have occurred                                  |                                   |                                  |                   |     |
| WHEN  | the data breach occurs on or after the date of commencement of PDP(A)A 2020 §13 |                                   |                                  |                   |     |
| ->    | assess                                                                          | if it is a Notifiable Data Breach |                                  |                   |     |
|       | by                                                                              | performing                        |                                  | NDB Qualification |     |
| HENCE | Notification                                                                    |                                   |                                  |                   |     |
| LEST  | PARTY                                                                           | the PDPC                          |                                  |                   |     |
|       | MAY                                                                             | demand                            | an explanation for your inaction |                   |     |
|       | HENCE                                                                           | PARTY                             | You                              |                   |     |
|       |                                                                                 | MUST                              | respond                          |                   |     |
|       |                                                                                 |                                   | to                               | the PDPC          |     |
|       |                                                                                 |                                   | about                            | your inaction     |     |

if this works when "respond" "to" "about" are in the same column, then we need to extend the paramtext parser to handle EOL. But let's see first if the failure is happening earlier.

*** let's try it with slightly different indentation
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-1-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§    | Assess                                                                          |                                   |                                  |                   |               |
| EVERY | Organisation                                                                    |                                   |                                  | AKA               | You           |
| WHO   | is                                                                              | not                               | a Public Agency                  |                   |               |
| MUST  | WITHIN                                                                          | 30                                | days                             |                   |               |
| UPON  | becoming aware a data breach may have occurred                                  |                                   |                                  |                   |               |
| WHEN  | the data breach occurs on or after the date of commencement of PDP(A)A 2020 §13 |                                   |                                  |                   |               |
| ->    | assess                                                                          | if it is a Notifiable Data Breach |                                  |                   |               |
|       | by                                                                              | performing                        |                                  | NDB Qualification |               |
| HENCE | Notification                                                                    |                                   |                                  |                   |               |
| LEST  | PARTY                                                                           | the PDPC                          |                                  |                   |               |
|       | MAY                                                                             | demand                            | an explanation for your inaction |                   |               |
|       | HENCE                                                                           | PARTY                             | You                              |                   |               |
|       |                                                                                 | MUST                              | respond                          |                   |               |
|       |                                                                                 |                                   |                                  | to                | the PDPC      |
|       |                                                                                 |                                   |                                  | about             | your inaction |

*** Nested Or Group with pre/post labels

**** with pre
:PROPERTIES:
:TABLE_EXPORT_FILE: nested-or-pre.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

|       | degustates                          |       |
| MEANS | eats                                |       |
| OR    | drinking, meaning any of the below: |       |
|       |                                     | sips  |
|       | OR                                  | chugs |

*** do rulelabels even work? standalone
:PROPERTIES:
:TABLE_EXPORT_FILE: prulelabel-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| § | My First Rule |

*** do rulelabels even work? followed by some token
:PROPERTIES:
:TABLE_EXPORT_FILE: prulelabel-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §     | My First Rule |
| GIVEN |               |

*** do rulelabels even work? followed by some token indented
:PROPERTIES:
:TABLE_EXPORT_FILE: prulelabel-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| § | My First Rule |
|   | GIVEN         |

*** Scenarios

**** mathematics
:PROPERTIES:
:TABLE_EXPORT_FILE: scenario-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §      | Scenario 1   |            |    |             |      |            |    |   |
| GIVEN  | amount saved |            | IS | 22000       |      |            |    |   |
|        | earnings     | amount     | IS | 25000       |      |            |    |   |
|        | earnings     | steadiness | IS | steady      |      |            |    |   |
| EXPECT |              | investment | IS | savings     | WHEN | dependents | IS | 5 |
| "      |              | "          | "  | combination | "    | "          | "  | 3 |
| "      |              | "          | "  | stocks      | "    | "          | "  | 0 |

**** unit test 1: misplaced storage drive
:PROPERTIES:
:TABLE_EXPORT_FILE: scenario-units-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| SCENARIO | Misplaced storage drive                                                                                             |          |                                         |   |
| GIVEN    | the data breach is in relation to any prescribed personal data or class of personal data relating to the individual |          |                                         |   |
| GIVEN    | loss of storage medium on which personal data is stored in circumstances where the unauthorised                     | disposal | of the personal data is likely to occur |   |
| GIVEN    | the data breach occurred only within an organisation                                                                |          |                                         |   |
| EXPECT   | IT IS                                                                                                               | NOT      | A Notifiable Data Breach                |   |



**** unit test 2-a: multiple organisations
:PROPERTIES:
:TABLE_EXPORT_FILE: scenario-units-2-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:



|   | (AdvG p131) |   | § | SCENARIO |     | Data breach involving multiple organisations                                                                        |   |                          |            |                                                                                                      |                  | for ABC   |          |
|   |             |   |   | GIVEN    |     | Organisation's name                                                                                                 |   |                          |            |                                                                                                      | IS               | ABC       |          |
|   |             |   |   | GIVEN    |     | the data breach is in relation to any prescribed personal data or class of personal data relating to the individual |   |                          |            |                                                                                                      |                  |           |          |
|   |             |   |   | GIVEN    |     | unauthorised                                                                                                        |   |                          | disclosure |                                                                                                      | of personal data |           | occurred |
|   |             |   |   | GIVEN    | NOT | the data breach occurred only within an organisation                                                                |   |                          |            |                                                                                                      |                  |           |          |
|   |             |   |   | GIVEN    |     | the data breach relates to                                                                                          |   |                          |            | the individual's                                                                                     |                  | full name |          |
|   |             |   |   | GIVEN    |     | the data breach relates to                                                                                          |   |                          |            | The number of any credit card, charge card or debit card issued to or in the name of the individual. |                  |           |          |
|   |             |   |   | EXPECT   |     | IT IS                                                                                                               |   | A Notifiable Data Breach |            |                                                                                                      |                  |           |          |
|   |             |   |   | EXPECT   |     | Organisation                                                                                                        |   | MUST                     |            | notify PDPC                                                                                          |                  |           |          |
|   |             |   |   | EXPECT   |     | Organisation                                                                                                        |   | MUST                     |            | notify Affected Individuals                                                                          |                  |           |          |
|   |             |   |   |          |     |                                                                                                                     |   |                          |            |                                                                                                      |                  |           |          |



**** unit test 2-b: multiple organisations
:PROPERTIES:
:TABLE_EXPORT_FILE: scenario-units-2-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:



|   | (AdvG p131) |   | § | SCENARIO |     | Data breach involving multiple organisations                                                                        |   |                          |            |                                                                                                      |                  | for DEF and GHI |                                                                                                                            |
|   |             |   |   | GIVEN    |     | Organisation's name                                                                                                 |   |                          |            | IS                                                                                                   | ONE OF           | DEF             | GHI                                                                                                                        |
|   |             |   |   | GIVEN    |     | the data breach is in relation to any prescribed personal data or class of personal data relating to the individual |   |                          |            |                                                                                                      |                  |                 |                                                                                                                            |
|   |             |   |   | GIVEN    |     | unauthorised                                                                                                        |   |                          | disclosure |                                                                                                      | of personal data |                 | occurred                                                                                                                   |
|   |             |   |   | GIVEN    | NOT | the data breach occurred only within an organisation                                                                |   |                          |            |                                                                                                      |                  |                 |                                                                                                                            |
|   |             |   |   | GIVEN    |     | the data breach relates to                                                                                          |   |                          |            | the individual's                                                                                     |                  | full name       |                                                                                                                            |
|   |             |   |   | GIVEN    |     | the data breach relates to                                                                                          |   |                          |            | The number of any credit card, charge card or debit card issued to or in the name of the individual. |                  |                 |                                                                                                                            |
|   |             |   |   | GIVEN    |     | PDPC instructs you not to notify them                                                                               |   |                          |            |                                                                                                      |                  | //              | "The organisations, in consultation with the Commission, agree that ABC is best positioned to notify the affected members" |
|   |             |   |   | EXPECT   |     | IT IS                                                                                                               |   | A Notifiable Data Breach |            |                                                                                                      |                  |                 |                                                                                                                            |
|   |             |   |   | EXPECT   |     | Organisation                                                                                                        |   | MUST                     |            | notify PDPC                                                                                          |                  |                 |                                                                                                                            |
|   |             |   |   | EXPECT   | NOT | Organisation                                                                                                        |   | MUST                     |            | notify Affected Individuals                                                                          |                  |                 |                                                                                                                            |
|   |             |   |   |          |     |                                                                                                                     |   |                          |            |                                                                                                      |                  |                 |                                                                                                                            |
|   |             |   |   |          |     |                                                                                                                     |   |                          |            |                                                                                                      |                  |                 |                                                                                                                            |



**** unit test 3: medical records
:PROPERTIES:
:TABLE_EXPORT_FILE: scenario-units-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:



|   | (AdvG p138) |   | § | SCENARIO |   | Unauthorised access of patients’ medical records |   |                          |        |                             |                                                                                                                                            |          |                       |                                                                                                 |
|   |             |   |   | GIVEN    |   | the prescribed number of affected individuals    |   |                          |        |                             |                                                                                                                                            | IS       |                    50 |                                                                                                 |
|   |             |   |   | GIVEN    |   | unauthorised                                     |   |                          | access |                             | of personal data                                                                                                                           | occurred |                       |                                                                                                 |
|   |             |   |   | GIVEN    |   | the data breach relates to                       |   |                          |        |                             | the individual's                                                                                                                           |          | identification number |                                                                                                 |
|   |             |   |   | GIVEN    |   | the data breach relates to                       |   |                          |        |                             | The assessment, diagnosis, treatment, prevention or alleviation by a health professional of any of the following affecting the individual: |          |                       | any sexually-transmitted disease such as Chlamydial Genital Infection, Gonorrhoea and Syphilis; |
|   |             |   |   | EXPECT   |   | IT IS                                            |   | A Notifiable Data Breach |        |                             |                                                                                                                                            |          |                       |                                                                                                 |
|   |             |   |   | EXPECT   |   | Organisation                                     |   | MUST                     |        | notify PDPC                 |                                                                                                                                            |          |                       |                                                                                                 |
|   |             |   |   | EXPECT   |   | Organisation                                     |   | MUST                     |        | notify Affected Individuals |                                                                                                                                            |          |                       |                                                                                                 |
|   |             |   |   |          |   |                                                  |   |                          |        |                             |                                                                                                                                            |          |                       |                                                                                                 |
|   |             |   |   |          |   |                                                  |   |                          |        |                             |                                                                                                                                            |          |                       |                                                                                                 |



**** unit test 4: hotel
:PROPERTIES:
:TABLE_EXPORT_FILE: scenario-units-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:


|   | (AdvG p139) |   | § | SCENARIO |   | Theft of portable storage drive containing hotel guests’ details |   |                          |        |                             |                                                                                                      |   |          |                       |                                                                                                 |
|   |             |   |   | GIVEN    |   | the prescribed number of affected individuals                    |   |                          |        |                             |                                                                                                      |   | IS       | 1000                  |                                                                                                 |
|   |             |   |   | GIVEN    |   | unauthorised                                                     |   |                          | access |                             | of personal data                                                                                     |   | occurred |                       |                                                                                                 |
|   |             |   |   | GIVEN    |   | the data breach relates to                                       |   |                          |        |                             | the individual's                                                                                     |   |          | full name             |                                                                                                 |
|   |             |   |   | GIVEN    |   | the data breach relates to                                       |   |                          |        |                             | the individual's                                                                                     |   |          | identification number | any sexually-transmitted disease such as Chlamydial Genital Infection, Gonorrhoea and Syphilis; |
|   |             |   |   | GIVEN    |   | the data breach relates to                                       |   |                          |        |                             | The number of any credit card, charge card or debit card issued to or in the name of the individual. |   |          |                       |                                                                                                 |
|   |             |   |   | EXPECT   |   | IT IS                                                            |   | A Notifiable Data Breach |        |                             |                                                                                                      |   |          |                       |                                                                                                 |
|   |             |   |   | EXPECT   |   | Organisation                                                     |   | MUST                     |        | notify PDPC                 |                                                                                                      |   |          |                       |                                                                                                 |
|   |             |   |   | EXPECT   |   | Organisation                                                     |   | MUST                     |        | notify Affected Individuals |                                                                                                      |   |          |                       |                                                                                                 |


*** Decide has a WHEN and AND on separate lines
:PROPERTIES:
:TABLE_EXPORT_FILE: financialadvisor-decide-1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | income   |            | IS | adequate |           |   |   |   |   |   |
| WHEN   | earnings | steadiness | IS | steady   |           |   |   |   |   |   |
| AND    | earnings | amount     |    | >        | minincome |   |   |   |   |   |
|        |          |            |    |          |           |   |   |   |   |   |

*** Decide has a WHEN separate and AND on same line
:PROPERTIES:
:TABLE_EXPORT_FILE: financialadvisor-decide-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | income   |            | IS | adequate |     |          |        |   |   |           |
| WHEN   | earnings | steadiness | IS | steady   | AND | earnings | amount |   | > | minincome |

*** Decide has a WHEN and AND on the same line
:PROPERTIES:
:TABLE_EXPORT_FILE: financialadvisor-decide-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | income |   | IS | adequate | WHEN | earnings | steadiness | IS | steady | AND | earnings | amount |   | > | minincome |   |


*** Decide has an OTHERWISE default
:PROPERTIES:
:TABLE_EXPORT_FILE: financialadvisor-decide-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| DECIDE | income |   | IS | adequate   | WHEN | earnings  | steadiness | IS | steady | AND | earnings | amount |   | > | minincome |   |
| "      | "      |   | "  | inadequate |      | OTHERWISE |            |    |        |     |          |        |   |   |           |   |

*** More PDPA Stuff                                                                     :pdpadbno:

**** 2: Data Intermediaries, Part 1
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-2.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§    | Data Intermediary non PA                                                        |                                                                               |     |     |
| EVERY | Data Intermediary                                                               |                                                                               | AKA | You |
| WHICH | is not                                                                          | processing personal data on behalf of and for the purposes of a public agency |     |     |
| MUST  | without undue delay                                                             |                                                                               |     |     |
| UPON  | becoming aware a data breach involving a client Organisation may have occurred  |                                                                               |     |     |
| WHEN  | the data breach occurs on or after the date of commencement of PDP(A)A 2020 §13 |                                                                               |     |     |
| ➔     | NOTIFY                                                                          | the Organisation                                                              |     |     |
|       | for which                                                                       | you act as a Data Intermediary                                                |     |     |

**** 3: Data Intermediaries, Part 2
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-3.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§    | Data Intermediary for PA                                                        |                                |     |
| EVERY | Data Intermediary                                                               | AKA                            | You |
| WHICH | processes personal data on behalf of and for the purposes of a public agency    |                                |     |
| MUST  | without undue delay                                                             |                                |     |
| UPON  | becoming aware a data breach involving a client public agency may have occurred |                                |     |
| ➔     | NOTIFY                                                                          | the Public Agency              |     |
|       | for which                                                                       | you act as a Data Intermediary |     |

**** 4: setting   dataBreach { Notifiable = True }
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-4.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:


| §      | NDB Qualification |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
| DEFINE | a Data Breach     |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
| IS     | TRUE              | a Notifiable Data Breach                                                             |                                                                                                 |                                                                                                                     |          | AKA                                                                                   | NDB   |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
| IF     | TRUE              | a data breach                                                                        |                                                                                                 |                                                                                                                     | occurred |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   | MEANS                                                                                | any                                                                                             | unauthorised                                                                                                        |          |                                                                                       | FALSE | access                                                                                                      |                        |                  | // maybe the label also needs to be a paramtext!? ["any","unauthorised"]                           |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | FALSE | use                                                                                                         |                        |                  | // so that the test engine's GIVEN fact-finder can match  unauthorised disclosure of personal data |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | TRUE  | disclosure                                                                                                  |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | FALSE | copying                                                                                                     |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | FALSE | modification                                                                                                |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | TRUE  | disposal                                                                                                    |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 | of personal data                                                                                                    |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   | OR                                                                                   | loss of storage medium on which personal data is stored in circumstances where the unauthorised |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    | FALSE | access       |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         | OR | FALSE | use          |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         | OR | FALSE | disclosure   |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         | OR | FALSE | copying      |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         | OR | TRUE  | modification |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         | OR | TRUE  | disposal     |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   | of the personal data is likely to occur |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
| UNLESS | FALSE             | the data breach occurred only within an organisation                                 |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
| AND    | TRUE              | it results in, or is likely to result in, significant harm to an affected individual |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   | IF                                                                                   | FALSE                                                                                           | the data breach is in relation to any prescribed personal data or class of personal data relating to the individual |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 | IF                                                                                                                  | FALSE    | the data breach relates to                                                            |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       | TRUE  |                                                                                                             |                        | the individual’s | TRUE                                                                                               | full name             |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        | ,                | FALSE                                                                                              | alias                 |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        | OR               | FALSE                                                                                              | identification number |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | AND                                                                                   | FALSE | any of the prescribed personal data or classes of personal data relating to the individual                  |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       | set out in                                                                                                  | Part 1 of the Schedule |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       | subject to                                                                                                  | Part 2 of the Schedule |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   | OR                                                                                   | TRUE                                                                                            | in other prescribed circumstances.                                                                                  |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 | MEANS                                                                                                               | all of   | the following personal data relating to an individual’s account with an organisation: |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     | TRUE     | the individual’s account identifier                                                   |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | INCLUDES                                                                              | FALSE | an account                                                                                                  |                        | name             |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | TRUE  |                                                                                                             |                        | number           |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | FALSE | a number assigned to any account the individual has with an organisation that is a bank or finance company. |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 | AND                                                                                                                 | TRUE     | any                                                                                   | FALSE | password                                                                                                    |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       | TRUE  | security code                                                                                               |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       | FALSE | access code                                                                                                 |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       | FALSE | response to a security question                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       | FALSE | biometric data                                                                                              |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          | OR                                                                                    | FALSE | other data                                                                                                  |                        | that is          |                                                                                                    |                       |    | FALSE | used      |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       | or | FALSE | required  |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  | to                                                                                                 | allow                 |    | FALSE | access to |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       | or | FALSE | use of    |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  |                                                                                                    |                       |    |       |           |   |                                         |    |       |              |
|        |                   |                                                                                      |                                                                                                 |                                                                                                                     |          |                                                                                       |       |                                                                                                             |                        |                  | the individual’s account.                                                                          |                       |    |       |           |   |                                         |    |       |              |


**** 5: notification to PDPC
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-5.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§   | Notify PDPC |       |                         |                                                  |      |                                                              |                                                    |                                        |                         |
| You  | MUST        |       | WITHIN                  | 3                                                | days |                                                              |                                                    |                                        |                         |
| TRUE | IF          | TRUE  | it is                   | an NDB                                           |      |                                                              |                                                    |                                        |                         |
|      | UNLESS      | FALSE | you are a Public Agency |                                                  |      |                                                              |                                                    |                                        |                         |
|      |             |       |                         |                                                  |      |                                                              |                                                    |                                        |                         |
|      | ➔           |       | NOTIFY                  | the PDPC                                         |      |                                                              |                                                    |                                        |                         |
|      |             |       | in                      | the form and manner specified at www.pdpc.gov.sg |      |                                                              |                                                    |                                        |                         |
|      |             |       | with                    | a Notification Message                           |      |                                                              |                                                    | // can we link to a constitutive rule? |                         |
|      |             |       | and                     | (optional)                                       |      | a list of individuals for whom notification waiver is sought | // we need PTree parsing if we want to indent more |                                        |                         |
|      |             |       |                         |                                                  |      |                                                              |                                                    |                                        |                         |
|      | HENCE       |       | the PDPC                | MAY                                              |      | NOTIFY                                                       | you                                                |                                        |                         |
|      |             |       |                         |                                                  |      | with                                                         | a list of individuals to exclude from notification | AKA                                    | the PDPC Exclusion List |


**** 6: "Unlikely" significant harm exception
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-6.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§     | Unlikely      |                                                                                                     |     |                                                                                                      |
| GIVEN  | an individual |                                                                                                     |     |                                                                                                      |
|        | who           | is affected by an NDB                                                                               |     |                                                                                                      |
| DECIDE | it is         | unlikely that the notifiable data breach will result in significant harm to the affected individual | AKA | Unlikely                                                                                             |
| IF     | FALSE         | the organisation has taken any action                                                               | to  | render it unlikely that the notifiable data breach will result in significant harm to the individual |
| OR     | TRUE          | the organisation already implemented any technological measure                                      | "   | "                                                                                                    |



**** 7: Notification to users
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-7.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§     | Notify Individuals         |                                            |                                                    |                         |
| IF     | TRUE                       | it is                                      | an NDB                                             |                         |
| UNLESS | FALSE                      | you are a Public Agency                    |                                                    |                         |
| PARTY  | You                        |                                            |                                                    |                         |
| MUST   |                            | WITHIN                                     | 3                                                  | days                    |
| ➔      |                            | NOTIFY                                     | each of the Notifiable Individuals                 |                         |
|        |                            | in                                         | any manner that is reasonable in the circumstances |                         |
|        |                            | with                                       | a message obeying a certain format                 |                         |
| WHERE  | the Notifiable Individuals |                                            |                                                    |                         |
|        | MEANS                      | the set of individuals affected by the NDB |                                                    |                         |
|        |                            | LESS                                       | the individuals who are deemed                     | Unlikely                |
|        |                            | LESS                                       | the individuals on                                 | the PDPC Exclusion List |
|        |                            | LESS                                       | the individuals on                                 | the LEA Exclusion List  |
|        |                            |                                            |                                                    |                         |

**** 7 extras



***** pdpadbno-7-a: simpler regular version to test setPlus and setLess
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-7-a.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §§    | section 7    |                                |
| IF    | it is an NDB |                                |
| PARTY | You          |                                |
| MUST  | Party Hearty |                                |
| WHERE |              | Party Hearty                   |
|       | MEANS        | to party with great enthusiasm |

***** pdpadbno-7-b: simpler sugary version to test if an IF can precede a You Must
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-7-b.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

decision: a Sugary thing has to start with You MUST.

The "IF" line has to go below.

|     | §§    | section 7    |                                |                                |
| You | MUST  | Party Hearty |                                | // if you flip these two lines |
|     | IF    | it is an NDB |                                | // it doesn't parse.           |
|     | WHERE |              | Party Hearty                   |                                |
|     |       | MEANS        | to party with great enthusiasm |                                |

**** 8: Notification is 5 and 7. let's use rule groups to group specific rules
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-8.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| §            | Notification       |
| Notification |                    |
| MEANS        | Notify Individuals |
| AND          | Notify PDPC        |

**** Part 1 of the Schedule
:PROPERTIES:
:TABLE_EXPORT_FILE: pdpadbno-part1.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| any of the prescribed personal data or classes of personal data relating to the individual |       |       |     |                                                                                                                                                                                                                                                    |
| MEANS                                                                                      | FALSE |       |   1 | The amount of any wages, salary, fee, commission, bonus, gratuity, allowance or other remuneration paid or payable to the individual by any person, whether under a contract of service or a contract for services.                                |
| OR                                                                                         | FALSE |       |   2 | The income of the individual from the sale of any goods or property.                                                                                                                                                                               |
| OR                                                                                         | FALSE |       |   3 | The number of any credit card, charge card or debit card issued to or in the name of the individual.                                                                                                                                               |
| OR                                                                                         | FALSE |       |   4 | The number assigned to any account the individual has with any organisation that is a bank or finance company.                                                                                                                                     |
| OR                                                                                         | FALSE |       |   5 | Any information that identifies, or is likely to lead to the identification of, the individual as a child or young person who —                                                                                                                    |
|                                                                                            |       | FALSE | 5.a | is or had been the subject of any investigation under the CYPA;                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE | 5.b | is or had been arrested, on or after 1 July 2020, for an offence committed under any written law;                                                                                                                                                  |
|                                                                                            | OR    | FALSE | 5.c | is or had been taken into care or custody by the Director-General of Social Welfare, a protector, any officer generally or specially authorised in that behalf in writing by the Director-General or protector or a police officer under the CYPA; |
|                                                                                            | OR    | FALSE | 5.d | is attending or had attended a family programme in relation to an application to be made under section 50 of the CYPA;                                                                                                                             |
|                                                                                            | OR    | FALSE | 5.e | is or was the subject of an order made by a court under the CYPA; or                                                                                                                                                                               |
|                                                                                            | OR    | FALSE | 5.f | is or had been concerned in any proceedings in any court or on appeal from any court, whether the individual is the person against or in respect of whom the proceedings are taken or a witness in those proceedings.                              |

| OR                                                                                         | FALSE |       |    6 | Any information that identifies, or is likely to lead to the identification of —                                                                                                                                                                                                                                             |
|                                                                                            |       | FALSE |  6.a | the individual who has been or is the subject of any investigation, examination, assessment or treatment under the VAA relating to whether the individual is a vulnerable adult experiencing or at risk of abuse, neglect or self-neglect;                                                                                   |
|                                                                                            | OR    | FALSE |  6.b | the individual as a vulnerable adult who has been committed to a place of temporary care and protection or place of safety or to the care of a fit person under the VAA;                                                                                                                                                     |
|                                                                                            | OR    | FALSE |  6.c | the individual as a vulnerable adult who is the subject of an order made by a court under the VAA;                                                                                                                                                                                                                           |
|                                                                                            | OR    | FALSE |  6.d | a place of temporary care and protection or place of safety in which an individual or a vulnerable adult mentioned in sub-paragraph (a), (b) or (c) is committed, or the location of such a place of temporary care and protection or place of safety; or                                                                    |
|                                                                                            | OR    | FALSE |  6.e | a fit person under whose care an individual or a vulnerable adult mentioned in sub-paragraph (a), (b) or (c) is placed, or the location of the premises of such a fit person.                                                                                                                                                |
| OR                                                                                         | FALSE |       |    7 | Any private key of or relating to the individual that is used or may be used —                                                                                                                                                                                                                                               |
|                                                                                            |       | FALSE |  7.a | to create a secure electronic record or secure electronic signature;                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE |  7.b | to verify the integrity of a secure electronic record; or                                                                                                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE |  7.c | to verify the authenticity or integrity of a secure electronic signature.                                                                                                                                                                                                                                                    |
| OR                                                                                         | FALSE |       |    8 | The net worth of the individual.                                                                                                                                                                                                                                                                                             |
| OR                                                                                         | FALSE |       |    9 | The deposit of moneys by the individual with any organisation.                                                                                                                                                                                                                                                               |
| OR                                                                                         | FALSE |       |   10 | The withdrawal by the individual of moneys deposited with any organisation.                                                                                                                                                                                                                                                  |
| OR                                                                                         | FALSE |       |   11 | The granting by an organisation of advances, loans and other facilities by which the individual, being a customer of the organisation, has access to funds or financial guarantees.                                                                                                                                          |
| OR                                                                                         | FALSE |       |   12 | The incurring by the organisation of any liabilities other than those mentioned in paragraph 11 on behalf of the individual.                                                                                                                                                                                                 |
| OR                                                                                         | FALSE |       |   13 | The payment of any moneys, or transfer of any property, by any person to the individual, including the amount of the moneys paid or the value of the property transferred, as the case may be.                                                                                                                               |
| OR                                                                                         | FALSE |       |   14 | The creditworthiness of the individual.                                                                                                                                                                                                                                                                                      |
| OR                                                                                         | FALSE |       |   15 | The individual’s investment in any capital markets products.                                                                                                                                                                                                                                                                 |
| OR                                                                                         | FALSE |       |   16 | The existence, and amount due or outstanding, of any debt —                                                                                                                                                                                                                                                                  |
|                                                                                            |       | FALSE | 16.a | owed by the individual to an organisation; or                                                                                                                                                                                                                                                                                |
|                                                                                            | OR    | FALSE | 16.b | owed by an organisation to the individual.                                                                                                                                                                                                                                                                                   |
| OR                                                                                         | FALSE |       |   17 | Any of the following:                                                                                                                                                                                                                                                                                                        |
|                                                                                            |       | FALSE | 17.a | the terms and conditions of any accident and health policy or life policy (called in this item the applicable policy) of which the individual is the policy owner or under which the individual is a beneficiary;                                                                                                            |
|                                                                                            | OR    | FALSE | 17.b | the premium payable by the policy owner under the applicable policy;                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | 17.c | the benefits payable to any beneficiary under the applicable policy;                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | 17.d | any information relating to any claim on, or payment under, the applicable policy, including the condition of the health of the individual and the diagnosis, treatment, prevention or alleviation of any ailment, condition, disability, disease, disorder or injury that the individual has suffered or is suffering from; |
|                                                                                            | OR    | FALSE | 17.e | any other information that the individual is the policy owner of, or a beneficiary under, an applicable policy.                                                                                                                                                                                                              |
| OR                                                                                         | FALSE |       |   18 | The assessment, diagnosis, treatment, prevention or alleviation by a health professional of any of the following affecting the individual:                                                                                                                                                                                   |
|                                                                                            |       | FALSE | 18.a | any sexually-transmitted disease such as Chlamydial Genital Infection, Gonorrhoea and Syphilis;                                                                                                                                                                                                                              |
|                                                                                            | OR    | FALSE | 18.b | Human Immunodeficiency Virus Infection;                                                                                                                                                                                                                                                                                      |
|                                                                                            | OR    | FALSE | 18.c | schizophrenia or delusional disorder;                                                                                                                                                                                                                                                                                        |
|                                                                                            | OR    | FALSE | 18.d | substance abuse and addiction, including drug addiction and alcoholism.                                                                                                                                                                                                                                                      |
| OR                                                                                         | FALSE |       |   19 | The provision of treatment to the individual for or in respect of —                                                                                                                                                                                                                                                          |
|                                                                                            |       | FALSE | 19.a | the donation or receipt of a human egg or human sperm; or                                                                                                                                                                                                                                                                    |
|                                                                                            | OR    | FALSE | 19.b | any contraceptive operation or procedure or abortion.                                                                                                                                                                                                                                                                        |
| OR                                                                                         | FALSE |       |   20 | Any of the following:                                                                                                                                                                                                                                                                                                        |
|                                                                                            |       | FALSE | 20.a | subject to section 4(4)(b) of the Act, the donation and removal of any organ from the body of the deceased individual for the purpose of its transplantation into the body of another individual;                                                                                                                            |
|                                                                                            | OR    | FALSE | 20.b | the donation and removal of any specified organ from the individual, being a living organ donor, for the purpose of its transplantation into the body of another individual;                                                                                                                                                 |
|                                                                                            | OR    | FALSE | 20.c | the transplantation of any organ mentioned in sub-paragraph (a) or (b) into the body of the individual.                                                                                                                                                                                                                      |
| OR                                                                                         | FALSE |       |   21 | Subject to section 4(4)(b) of the Act, the suicide or attempted suicide of the individual.                                                                                                                                                                                                                                   |
| OR                                                                                         | FALSE |       |   22 | Domestic abuse, child abuse or sexual abuse involving or alleged to involve the individual.                                                                                                                                                                                                                                  |
| OR                                                                                         | FALSE |       |   23 | Any of the following:                                                                                                                                                                                                                                                                                                        |
|                                                                                            |       | FALSE | 23.a | information that the individual is or had been adopted pursuant to an adoption order made under the Adoption of Children Act (Cap. 4), or is or had been the subject of an application for an adoption order;                                                                                                                |
|                                                                                            | OR    | FALSE | 23.b | the identity of the natural father or mother of the individual;                                                                                                                                                                                                                                                              |
|                                                                                            | OR    | FALSE | 23.c | the identity of the adoptive father or mother of the individual;                                                                                                                                                                                                                                                             |
|                                                                                            | OR    | FALSE | 23.d | the identity of any applicant for an adoption order;                                                                                                                                                                                                                                                                         |
|                                                                                            | OR    | FALSE | 23.e | the identity of any person whose consent is necessary under that Act for an adoption order to be made, whether or not the court has dispensed with the consent of that person in accordance with that Act;                                                                                                                   |
|                                                                                            | OR    | FALSE | 23.f | any other information that the individual is or had been an adopted child or relating to the adoption of the individual.                                                                                                                                                                                                     |
|                                                                                            |       |       |      |                                                                                                                                                                                                                                                                                                                              |



** intro examples

*** you may park
:PROPERTIES:
:TABLE_EXPORT_FILE: intro-park.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| EVERY | Person                |     |      |
| MAY   | park                  | for | free |
| UNTIL | midnight              |     |      |
| WHEN  | it is an Off-Peak Day |     |      |

*** off-peak day
:PROPERTIES:
:TABLE_EXPORT_FILE: intro-offpeak.csv
:TABLE_EXPORT_FORMAT: orgtbl-to-csv
:END:

| IT IS | an Off-Peak Day        |
| IF    | it is a weekend        |
| OR    | it is a public holiday |
